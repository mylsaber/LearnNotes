<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1 Service概述 | 迪</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="迪的文档">
    
    <link rel="preload" href="/assets/css/0.styles.d6ad21ed.css" as="style"><link rel="preload" href="/assets/js/app.7bd49d80.js" as="script"><link rel="preload" href="/assets/js/2.63c13255.js" as="script"><link rel="preload" href="/assets/js/65.aa0ff0bb.js" as="script"><link rel="prefetch" href="/assets/js/10.3494fc42.js"><link rel="prefetch" href="/assets/js/11.729c2ddc.js"><link rel="prefetch" href="/assets/js/12.2cbdbb2e.js"><link rel="prefetch" href="/assets/js/13.d9240596.js"><link rel="prefetch" href="/assets/js/14.482de4d9.js"><link rel="prefetch" href="/assets/js/15.5aafb57e.js"><link rel="prefetch" href="/assets/js/16.d8b25bdc.js"><link rel="prefetch" href="/assets/js/17.c59992e9.js"><link rel="prefetch" href="/assets/js/18.84364966.js"><link rel="prefetch" href="/assets/js/19.a2c00930.js"><link rel="prefetch" href="/assets/js/20.a708eb81.js"><link rel="prefetch" href="/assets/js/21.43accc43.js"><link rel="prefetch" href="/assets/js/22.f62a2950.js"><link rel="prefetch" href="/assets/js/23.34d0cd46.js"><link rel="prefetch" href="/assets/js/24.5338688c.js"><link rel="prefetch" href="/assets/js/25.49e53738.js"><link rel="prefetch" href="/assets/js/26.16ae9f2c.js"><link rel="prefetch" href="/assets/js/27.3a6d8ae8.js"><link rel="prefetch" href="/assets/js/28.c1d13fc9.js"><link rel="prefetch" href="/assets/js/29.6f2861b0.js"><link rel="prefetch" href="/assets/js/3.8a8baccb.js"><link rel="prefetch" href="/assets/js/30.e84371ac.js"><link rel="prefetch" href="/assets/js/31.5c72212f.js"><link rel="prefetch" href="/assets/js/32.6363355b.js"><link rel="prefetch" href="/assets/js/33.480aa18e.js"><link rel="prefetch" href="/assets/js/34.214d5115.js"><link rel="prefetch" href="/assets/js/35.e451acf7.js"><link rel="prefetch" href="/assets/js/36.40754204.js"><link rel="prefetch" href="/assets/js/37.c0669722.js"><link rel="prefetch" href="/assets/js/38.d21aec47.js"><link rel="prefetch" href="/assets/js/39.715eeabf.js"><link rel="prefetch" href="/assets/js/4.94733d25.js"><link rel="prefetch" href="/assets/js/40.11a9a769.js"><link rel="prefetch" href="/assets/js/41.36768ce0.js"><link rel="prefetch" href="/assets/js/42.ee1e0159.js"><link rel="prefetch" href="/assets/js/43.020fd64f.js"><link rel="prefetch" href="/assets/js/44.0c53e18b.js"><link rel="prefetch" href="/assets/js/45.4f3ef7b5.js"><link rel="prefetch" href="/assets/js/46.d9cdb5f2.js"><link rel="prefetch" href="/assets/js/47.1adb3d38.js"><link rel="prefetch" href="/assets/js/48.610e96d6.js"><link rel="prefetch" href="/assets/js/49.55d8c57f.js"><link rel="prefetch" href="/assets/js/5.2ea06e07.js"><link rel="prefetch" href="/assets/js/50.6ebf433b.js"><link rel="prefetch" href="/assets/js/51.7c6b8f90.js"><link rel="prefetch" href="/assets/js/52.272766fb.js"><link rel="prefetch" href="/assets/js/53.376bcdaa.js"><link rel="prefetch" href="/assets/js/54.64b22200.js"><link rel="prefetch" href="/assets/js/55.88f31c2d.js"><link rel="prefetch" href="/assets/js/56.adf8ff90.js"><link rel="prefetch" href="/assets/js/57.aef54518.js"><link rel="prefetch" href="/assets/js/58.3fd47dd4.js"><link rel="prefetch" href="/assets/js/59.517e8369.js"><link rel="prefetch" href="/assets/js/6.8d81f0ec.js"><link rel="prefetch" href="/assets/js/60.e18cfb4f.js"><link rel="prefetch" href="/assets/js/61.cc67b7d0.js"><link rel="prefetch" href="/assets/js/62.b85288fb.js"><link rel="prefetch" href="/assets/js/63.d5389af7.js"><link rel="prefetch" href="/assets/js/64.07e60b5f.js"><link rel="prefetch" href="/assets/js/66.8e29c5d3.js"><link rel="prefetch" href="/assets/js/67.4c0457e3.js"><link rel="prefetch" href="/assets/js/68.4a42bf9a.js"><link rel="prefetch" href="/assets/js/69.8615447c.js"><link rel="prefetch" href="/assets/js/7.2259505f.js"><link rel="prefetch" href="/assets/js/70.868370f7.js"><link rel="prefetch" href="/assets/js/71.c2d2d815.js"><link rel="prefetch" href="/assets/js/72.632399c5.js"><link rel="prefetch" href="/assets/js/73.32018efb.js"><link rel="prefetch" href="/assets/js/74.f9c48ad4.js"><link rel="prefetch" href="/assets/js/75.50fefe6a.js"><link rel="prefetch" href="/assets/js/76.ccc13674.js"><link rel="prefetch" href="/assets/js/77.59a643be.js"><link rel="prefetch" href="/assets/js/78.fe57d4be.js"><link rel="prefetch" href="/assets/js/79.900d03e3.js"><link rel="prefetch" href="/assets/js/8.8a6f0706.js"><link rel="prefetch" href="/assets/js/80.de0bd2c2.js"><link rel="prefetch" href="/assets/js/9.b3b9c71b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d6ad21ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.jpg" alt="迪" class="logo"> <span class="site-name can-hide">迪</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/back-end/java/java集合.html" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/guide/前端/JavaScript/ES6.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/guide/other/docker/Docker.html" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="https://www.baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  百度
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/chinese.html" class="nav-link">
  中文
</a></li><li class="dropdown-item"><!----> <a href="/language/english.html" class="nav-link">
  English
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/back-end/java/java集合.html" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/guide/前端/JavaScript/ES6.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/guide/other/docker/Docker.html" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="https://www.baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  百度
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/chinese.html" class="nav-link">
  中文
</a></li><li class="dropdown-item"><!----> <a href="/language/english.html" class="nav-link">
  English
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>后端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/back-end/java/java集合.html" class="sidebar-link">java集合</a></li><li><a href="/guide/back-end/java/多线程.html" class="sidebar-link">多线程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>Kubernetes</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/other/Kubernetes/1.Kubernetes部署.html" class="sidebar-link">1.Kubernetes部署</a></li><li><a href="/guide/other/Kubernetes/2-Kubernetes资源管理方式.html" class="sidebar-link">2.Kubernetes资源管理方式</a></li><li><a href="/guide/other/Kubernetes/3-Kubernetes的对象.html" class="sidebar-link">3.Kubernetes的对象</a></li><li><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html" class="sidebar-link">4.Kubernetes的Pod</a></li><li><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html" class="sidebar-link">5.Kubernetes的控制器</a></li><li><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html" class="active sidebar-link">6.Kubernetes的Service</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_3-1-环境准备" class="sidebar-link">3.1 环境准备</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_3-2-clusterip类型的service" class="sidebar-link">3.2 ClusterIP类型的Service</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_3-2-1-创建service" class="sidebar-link">3.2.1 创建Service</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_3-2-2-查看service" class="sidebar-link">3.2.2 查看Service</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_3-2-3-查看ipvs映射规则" class="sidebar-link">3.2.3 查看ipvs映射规则</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_3-2-4-endpoint-使用不多" class="sidebar-link">3.2.4 Endpoint（使用不多）</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_3-2-5-负载分发策略" class="sidebar-link">3.2.5 负载分发策略</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_3-2-6-删除service" class="sidebar-link">3.2.6 删除Service</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_3-3-headliness类型的service" class="sidebar-link">3.3 HeadLiness类型的Service</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_3-3-1-创建service" class="sidebar-link">3.3.1 创建Service</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_3-3-2-查看service" class="sidebar-link">3.3.2 查看Service</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_3-3-3-查看service详情" class="sidebar-link">3.3.3 查看Service详情</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_3-3-4-查看域名解析情况" class="sidebar-link">3.3.4 查看域名解析情况</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_3-3-5-通过service的域名进行查询" class="sidebar-link">3.3.5 通过Service的域名进行查询</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_4-nodeport类型的service" class="sidebar-link">4 NodePort类型的Service</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_4-1-创建service" class="sidebar-link">4.1 创建Service</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_4-2-查看service" class="sidebar-link">4.2 查看Service</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_4-3-访问" class="sidebar-link">4.3 访问</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_5-loadbalancer类型的service" class="sidebar-link">5 LoadBalancer类型的Service</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_6-externalname类型的service" class="sidebar-link">6 ExternalName类型的Service</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_6-1-创建service" class="sidebar-link">6.1 创建Service</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_5-1-环境准备" class="sidebar-link">5.1 环境准备</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_5-1-1-搭建ingress环境" class="sidebar-link">5.1.1 搭建Ingress环境</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_5-1-2-准备service和pod" class="sidebar-link">5.1.2 准备Service和Pod</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_5-2-http代理" class="sidebar-link">5.2 http代理</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html#_5-3-https代理" class="sidebar-link">5.3 https代理</a></li></ul></li><li><a href="/guide/other/Kubernetes/7-Kubernetes的数据存储.html" class="sidebar-link">7.Kubernetes的数据存储</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/other/Linux/Linux.html" class="sidebar-link">Linux</a></li><li><a href="/guide/other/Linux/Linux基础.html" class="sidebar-link">Linux基础</a></li><li><a href="/guide/other/Linux/Shell脚本.html" class="sidebar-link">Shell脚本</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>项目管理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/other/project-manage/git.html" class="sidebar-link">Git</a></li><li><a href="/guide/other/project-manage/maven.html" class="sidebar-link">Maven</a></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_1-service概述"><a href="#_1-service概述" class="header-anchor">#</a> 1 Service概述</h1> <p>在kubernetes中，Pod是应用程序的载体，我们可以通过Pod的IP来访问应用程序，但是Pod的IP地址不是固定的，这就意味着不方便直接采用Pod的IP对服务进行访问。
为了解决这个问题，kubernetes提供了Service资源，Service会对提供同一个服务的多个Pod进行聚合，并且提供一个统一的入口地址，通过访问Service的入口地址就能访问到后面的Pod服务。
Service在很多情况下只是一个概念，真正起作用的其实是kube-proxy服务进程，每个Node节点上都运行了一个kube-proxy的服务进程。当创建Service的时候会通过API Server向etcd写入创建的Service的信息，而kube-proxy会基于监听的机制发现这种Service的变化，然后它会将最新的Service信息转换为对应的访问规则。
kube-proxy目前支持三种工作模式：</p> <ul><li>userspace模式：userspace模式下，kube-proxy会为每一个Service创建一个监听端口，发向Cluster IP的请求被iptables规则重定向到kube-proxy监听的端口上，kube-proxy根据LB算法（负载均衡算法）选择一个提供服务的Pod并和其建立连接，以便将请求转发到Pod上。该模式下，kube-proxy充当了一个四层负载均衡器的角色。由于kube-proxy运行在userspace中，在进行转发处理的时候会增加内核和用户空间之间的数据拷贝，虽然比较稳定，但是效率非常低下。</li> <li>iptables模式：iptables模式下，kube-proxy为Service后端的每个Pod创建对应的iptables规则，直接将发向Cluster IP的请求重定向到一个Pod的IP上。该模式下kube-proxy不承担四层负载均衡器的角色，只负责创建iptables规则。该模式的优点在于较userspace模式效率更高，但是不能提供灵活的LB策略，当后端Pod不可用的时候无法进行重试。</li> <li>ipvs模式： ipvs模式和iptables类似，kube-proxy监控Pod的变化并创建相应的ipvs规则。ipvs相对iptables转发效率更高，除此之外，ipvs支持更多的LB算法。</li></ul> <p><strong>开启ipvs</strong>（必须安装ipvs内核模块，否则会降级为iptables）</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl edit cm kube-proxy <span class="token parameter variable">-n</span> kube-system
<span class="token comment"># 设置mode=&quot;ipvs&quot;</span>
</code></pre></div><p>删除kube-proxy，让集群重启这个pod</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl delete pod <span class="token parameter variable">-l</span> k8s-app<span class="token operator">=</span>kube-proxy <span class="token parameter variable">-n</span> kube-system
</code></pre></div><h1 id="_2-service类型"><a href="#_2-service类型" class="header-anchor">#</a> 2 Service类型</h1> <p>Service的资源清单：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1 <span class="token comment"># 版本</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service <span class="token comment"># 类型</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># 资源名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># 命名空间</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 标签选择器，用于确定当前Service代理那些Pod</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort <span class="token comment"># Service的类型，指定Service的访问方式</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> <span class="token comment"># 虚拟服务的IP地址</span>
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> <span class="token comment"># session亲和性，支持ClientIP、None两个选项，默认值为None</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment"># 端口信息</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span> <span class="token comment"># Service端口</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP <span class="token comment"># 协议</span>
      <span class="token key atrule">targetPort</span> <span class="token punctuation">:</span> <span class="token comment"># Pod端口</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span>  <span class="token comment"># 主机端口</span>
</code></pre></div><blockquote><p>spec.type的说明：</p> <ul><li>ClusterIP：默认值，它是kubernetes系统自动分配的虚拟IP，只能在集群内部访问。</li> <li>NodePort：将Service通过指定的Node上的端口暴露给外部，通过此方法，就可以在集群外部访问服务。</li> <li>LoadBalancer：使用外接负载均衡器完成到服务的负载分发，注意此模式需要外部云环境的支持。</li> <li>ExternalName：把集群外部的服务引入集群内部，直接使用。</li></ul></blockquote> <h1 id="_3-service使用"><a href="#_3-service使用" class="header-anchor">#</a> 3 Service使用</h1> <h2 id="_3-1-环境准备"><a href="#_3-1-环境准备" class="header-anchor">#</a> 3.1 环境准备</h2> <p>在使用Service之前，首先利用Deployment创建出3个Pod，注意要为Pod设置<code>app=nginx-pod</code>的标签。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>deployment
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><p><strong>创建Deployment：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create <span class="token parameter variable">-f</span> deployment.yaml
</code></pre></div><p><strong>查看pod：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pod <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-o</span> wide --show-labels
</code></pre></div><p><strong>方便测试修改nginx的index.html</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pc-deployment-5ffc5bf56c-6sp2k <span class="token parameter variable">-c</span> nginx <span class="token parameter variable">-n</span> dev /bin/sh
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">echo</span> <span class="token string">&quot;10.244.1.163&quot;</span> <span class="token operator">&gt;</span> /usr/share/nginx/html/index.html
</code></pre></div><h2 id="_3-2-clusterip类型的service"><a href="#_3-2-clusterip类型的service" class="header-anchor">#</a> 3.2 ClusterIP类型的Service</h2> <h3 id="_3-2-1-创建service"><a href="#_3-2-1-创建service" class="header-anchor">#</a> 3.2.1 创建Service</h3> <p><strong>创建service-clusterip.yaml文件：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>clusterip
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.97.97.97 <span class="token comment"># service的IP地址，如果不写，默认会生成一个</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># Service的端口</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># Pod的端口</span>
</code></pre></div><p><strong>创建Service：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create <span class="token parameter variable">-f</span> service-clusterip.yaml
</code></pre></div><h3 id="_3-2-2-查看service"><a href="#_3-2-2-查看service" class="header-anchor">#</a> 3.2.2 查看Service</h3> <p><strong>查看：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get svc <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-o</span> wide
</code></pre></div><p><strong>查看详细信息：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl describe svc service-clusterip <span class="token parameter variable">-n</span> dev
</code></pre></div><p>Endpoints列表里就是当前Service可以负载到的服务入口</p> <h3 id="_3-2-3-查看ipvs映射规则"><a href="#_3-2-3-查看ipvs映射规则" class="header-anchor">#</a> 3.2.3 查看ipvs映射规则</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>ipvsadm <span class="token parameter variable">-Ln</span>
</code></pre></div><h3 id="_3-2-4-endpoint-使用不多"><a href="#_3-2-4-endpoint-使用不多" class="header-anchor">#</a> 3.2.4 Endpoint（使用不多）</h3> <p>Endpoint是kubernetes中的一个资源对象，存储在etcd中，用来记录一个service对应的所有Pod的访问地址，它是根据service配置文件中的selector描述产生的。
一个service由一组Pod组成，这些Pod通过Endpoints暴露出来，Endpoints是实现实际服务的端点集合。换言之，service和Pod之间的联系是通过Endpoints实现的。
<strong>查看Endpoint：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get endpoints <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-o</span> wide
</code></pre></div><h3 id="_3-2-5-负载分发策略"><a href="#_3-2-5-负载分发策略" class="header-anchor">#</a> 3.2.5 负载分发策略</h3> <p>对Service的访问被分发到了后端的Pod上去，目前kubernetes提供了两种负载分发策略：</p> <ul><li>如果不定义，默认使用kube-proxy的策略，比如随机、轮询等。</li> <li>基于客户端地址的会话保持模式，即来自同一个客户端发起的所有请求都会转发到固定的一个Pod上，这对于传统基于Session的认证项目来说很友好，此模式可以在spec中添加<code>sessionAffinity: ClusterIP</code>选项。</li></ul> <p>查看ipvs的映射规则，rr表示轮询：</p> <h4 id="_3-2-5-1-修改分发策略"><a href="#_3-2-5-1-修改分发策略" class="header-anchor">#</a> 3.2.5.1 修改分发策略</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>clusterip
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.97.97.97 <span class="token comment"># service的IP地址，如果不写，默认会生成一个</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> ClientIP <span class="token comment"># 修改分发策略为基于客户端地址的会话保持模式</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># Service的端口</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># Pod的端口</span>
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> service-clusterip.yaml
</code></pre></div><h3 id="_3-2-6-删除service"><a href="#_3-2-6-删除service" class="header-anchor">#</a> 3.2.6 删除Service</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl delete <span class="token parameter variable">-f</span> service-clusterip.yaml
</code></pre></div><h2 id="_3-3-headliness类型的service"><a href="#_3-3-headliness类型的service" class="header-anchor">#</a> 3.3 HeadLiness类型的Service</h2> <p>在某些场景中，开发人员可能不想使用Service提供的负载均衡功能，而希望自己来控制负载均衡策略，针对这种情况，kubernetes提供了HeadLinesss Service，这类Service不会分配Cluster IP，如果想要访问Service，只能通过Service的域名进行查询。</p> <h3 id="_3-3-1-创建service"><a href="#_3-3-1-创建service" class="header-anchor">#</a> 3.3.1 创建Service</h3> <p><strong>创建service-headliness.yaml文件：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>headliness
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None <span class="token comment"># 将clusterIP设置为None，即可创建headliness Service</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># Service的端口</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># Pod的端口</span>
</code></pre></div><p><strong>发布Service：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create <span class="token parameter variable">-f</span> service-headliness.yaml
</code></pre></div><h3 id="_3-3-2-查看service"><a href="#_3-3-2-查看service" class="header-anchor">#</a> 3.3.2 查看Service</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get svc service-headliness <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-o</span> wide
</code></pre></div><h3 id="_3-3-3-查看service详情"><a href="#_3-3-3-查看service详情" class="header-anchor">#</a> 3.3.3 查看Service详情</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl describe svc service-headliness <span class="token parameter variable">-n</span> dev
</code></pre></div><h3 id="_3-3-4-查看域名解析情况"><a href="#_3-3-4-查看域名解析情况" class="header-anchor">#</a> 3.3.4 查看域名解析情况</h3> <p>查看pod：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pod <span class="token parameter variable">-n</span> dev
</code></pre></div><p>进入pod，执行<code>cat /etc/resolv.conf</code>命令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl <span class="token builtin class-name">exec</span>  pc-deployment-5ffc5bf56c-5dmw7 <span class="token parameter variable">-n</span> dev -- <span class="token function">cat</span> /etc/resolv.conf
</code></pre></div><h3 id="_3-3-5-通过service的域名进行查询"><a href="#_3-3-5-通过service的域名进行查询" class="header-anchor">#</a> 3.3.5 通过Service的域名进行查询</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">dig</span> @10.96.0.10 service-headliness.dev.svc.cluster.local
</code></pre></div><h2 id="_4-nodeport类型的service"><a href="#_4-nodeport类型的service" class="header-anchor">#</a> 4 NodePort类型的Service</h2> <p>在之前的案例中，创建的Service的IP地址只能在集群内部才可以访问，如果希望Service暴露给集群外部使用，那么就需要使用到另外一种类型的Service，称为NodePort类型的Service。NodePort的工作原理就是将Service的端口映射到Node的一个端口上，然后就可以通过<code>NodeIP:NodePort</code>来访问Service了。</p> <h3 id="_4-1-创建service"><a href="#_4-1-创建service" class="header-anchor">#</a> 4.1 创建Service</h3> <p><strong>创建service-nodeport.yaml文件：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>nodeport
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort <span class="token comment"># Service类型为NodePort</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># Service的端口</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># Pod的端口</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30002</span> <span class="token comment"># 指定绑定的node的端口（默认取值范围是30000~32767），如果不指定，会默认分配</span>
</code></pre></div><p><strong>发布Service：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create <span class="token parameter variable">-f</span> service-nodeport.yaml
</code></pre></div><h3 id="_4-2-查看service"><a href="#_4-2-查看service" class="header-anchor">#</a> 4.2 查看Service</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get svc service-nodeport <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-o</span> wide
</code></pre></div><h3 id="_4-3-访问"><a href="#_4-3-访问" class="header-anchor">#</a> 4.3 访问</h3> <p>通过集群节点即可访问对应的Pod。</p> <div class="language- extra-class"><pre class="language-text"><code>curl http://124.223.91.119:30086
</code></pre></div><h2 id="_5-loadbalancer类型的service"><a href="#_5-loadbalancer类型的service" class="header-anchor">#</a> 5 LoadBalancer类型的Service</h2> <p>LoadBalancer和NodePort很相似，目的都是向外部暴露一个端口，区别在于LoadBalancer会在集群的外部再来做一个负载均衡设备，而这个设备需要外部环境的支持，外部服务发送到这个设备上的请求，会被设备负载之后转发到集群中。</p> <h2 id="_6-externalname类型的service"><a href="#_6-externalname类型的service" class="header-anchor">#</a> 6 ExternalName类型的Service</h2> <p>ExternalName类型的Service用于引入集群外部的服务，它通过externalName属性指定一个服务的地址，然后在集群内部访问此Service就可以访问到外部的服务了。</p> <h3 id="_6-1-创建service"><a href="#_6-1-创建service" class="header-anchor">#</a> 6.1 创建Service</h3> <p><strong>创建service-externalname.yaml文件：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>apiVersion: v1
kind: Service
metadata:
  name: service-externalname
  namespace: dev
spec:
  type: ExternalName <span class="token comment"># Service类型为ExternalName</span>
  externalName: www.baidu.com <span class="token comment"># 改成IP地址也可以</span>
</code></pre></div><p><strong>发布Service：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create <span class="token parameter variable">-f</span> service-externalname.yaml
</code></pre></div><h1 id="_4-ingress介绍"><a href="#_4-ingress介绍" class="header-anchor">#</a> 4 Ingress介绍</h1> <p>我们已经知道，Service对集群之外暴露服务的主要方式有两种：NodePort和LoadBalancer，但是这两种方式，都有一定的缺点：</p> <ul><li>NodePort方式的缺点是会占用很多集群机器的端口，那么当集群服务变多的时候，这个缺点就愈发明显。</li> <li>LoadBalancer的缺点是每个Service都需要一个LB，浪费，麻烦，并且需要kubernetes之外的设备的支持。</li></ul> <p>基于这种现状，kubernetes提供了Ingress资源对象，Ingress只需要一个NodePort或者一个LB就可以满足暴露多个Service的需求。
实际上，Ingress相当于一个七层的负载均衡器，是Kubernetes对反向代理的一个抽象，它的工作原理类似于Nginx，可以理解为Ingress里面建立了诸多映射规则，Ingress Controller通过监听这些配置规则并转化为Nginx的反向代理配置，然后对外提供服务。</p> <ul><li>Ingress：Kubernetes中的一个对象，作用是定义请求如何转发到Service的规则。</li> <li>Ingress Controller：具体实现反向代理以及负载均衡的程序，对Ingress定义的规则进行解析，根据配置的规则来实现请求转发，实现的方式有很多，比如Nginx，Contour，Haproxy等。</li></ul> <p>Ingress的工作原理如下：</p> <ol><li>用户编写Ingress规则，说明那个域名对应Kubernetes集群中的那个Service。</li> <li>Ingress控制器动态感知Ingress服务规则的变化，然后生成一段对应的Nginx的反向代理配置。</li> <li>Ingress控制器会将生成的Nginx配置写入到一个运行着的Nginx服务中，并动态更新。</li></ol> <h1 id="_5-ingress使用"><a href="#_5-ingress使用" class="header-anchor">#</a> 5 Ingress使用</h1> <h2 id="_5-1-环境准备"><a href="#_5-1-环境准备" class="header-anchor">#</a> 5.1 环境准备</h2> <h3 id="_5-1-1-搭建ingress环境"><a href="#_5-1-1-搭建ingress环境" class="header-anchor">#</a> 5.1.1 搭建Ingress环境</h3> <p><strong>创建文件夹，并进入到此文件夹中：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mkdir</span> ingress-controller <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> ingress-controller
</code></pre></div><p><strong>获取Ingress的yaml配置：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">wget</span> https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml

<span class="token function">wget</span> https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml
</code></pre></div><p><strong>创建Ingress-nginx：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> ./
</code></pre></div><p><strong>查看ingress-nginx：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pod <span class="token parameter variable">-n</span> ingress-nginx
</code></pre></div><p><strong>查看Service：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get svc <span class="token parameter variable">-n</span> ingress-nginx
</code></pre></div><h3 id="_5-1-2-准备service和pod"><a href="#_5-1-2-准备service和pod" class="header-anchor">#</a> 5.1.2 准备Service和Pod</h3> <p>我们创建一个nginx-Service对应nginx的pod群和一个tomcat-Service对应tomcat的pod群。
<strong>创建tomcat-nginx.yaml文件：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>deployment
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
        <span class="token key atrule">image</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">:</span>8.5<span class="token punctuation">-</span>jre10<span class="token punctuation">-</span>slim
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>pod
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre></div><p><strong>创建Service和Pod：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create <span class="token parameter variable">-f</span> tomcat-nginx.yaml
</code></pre></div><p><strong>查看Service和Pod：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get svc,pod <span class="token parameter variable">-n</span> dev
</code></pre></div><h2 id="_5-2-http代理"><a href="#_5-2-http代理" class="header-anchor">#</a> 5.2 http代理</h2> <p><strong>创建ingress-http.yaml文件：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>http
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx.mylsaber.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> tomcat.mylsaber.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>service
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre></div><p><strong>创建：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create <span class="token parameter variable">-f</span> ingress-http.yaml
</code></pre></div><p><strong>查看：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get ingress ingress-http <span class="token parameter variable">-n</span> dev
</code></pre></div><p><strong>查看详情：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl describe ingress ingress-http <span class="token parameter variable">-n</span> dev
</code></pre></div><p><strong>在本机的hosts文件中添加规则：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token number">124.223</span>.91.119 nginx.mylsaber.com
<span class="token number">124.223</span>.91.119 tomcat.mylsaber.com
</code></pre></div><p><strong>查看ingress-nginx的端口：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get svc <span class="token parameter variable">-n</span> ingress-nginx
</code></pre></div><h2 id="_5-3-https代理"><a href="#_5-3-https代理" class="header-anchor">#</a> 5.3 https代理</h2> <p><strong>生成证书：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>openssl req <span class="token parameter variable">-x509</span> <span class="token parameter variable">-sha256</span> <span class="token parameter variable">-nodes</span> <span class="token parameter variable">-days</span> <span class="token number">365</span> <span class="token parameter variable">-newkey</span> rsa:2048 <span class="token parameter variable">-keyout</span> tls.key <span class="token parameter variable">-out</span> tls.crt <span class="token parameter variable">-subj</span> <span class="token string">&quot;/C=CN/ST=BJ/L=BJ/O=nginx/CN=mylsaber.com&quot;</span>
</code></pre></div><p><strong>创建秘钥：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create secret tls tls-secret <span class="token parameter variable">--key</span> tls.key <span class="token parameter variable">--cert</span> tls.crt
</code></pre></div><p><strong>创建ingress-https.yaml文件：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>https
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nginx.mylsaber.com
      <span class="token punctuation">-</span> tomcat.mylsaber.com
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> tls<span class="token punctuation">-</span>secret <span class="token comment"># 指定秘钥</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx.mylsaber.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>service
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> tomcat.mylsaber.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>service
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre></div><p><strong>创建：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create <span class="token parameter variable">-f</span> ingress-https.yaml
</code></pre></div><p><strong>查看：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get ingress ingress-https <span class="token parameter variable">-n</span> dev
</code></pre></div><p><strong>查看详情：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl describe ingress ingress-https <span class="token parameter variable">-n</span> dev
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html" class="prev">
        5.Kubernetes的控制器
      </a></span> <span class="next"><a href="/guide/other/Kubernetes/7-Kubernetes的数据存储.html">
        7.Kubernetes的数据存储
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7bd49d80.js" defer></script><script src="/assets/js/2.63c13255.js" defer></script><script src="/assets/js/65.aa0ff0bb.js" defer></script>
  </body>
</html>
