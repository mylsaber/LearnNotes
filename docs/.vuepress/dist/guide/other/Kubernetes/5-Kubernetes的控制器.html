<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1 概述 | 迪</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="迪的文档">
    
    <link rel="preload" href="/assets/css/0.styles.2b9f1a15.css" as="style"><link rel="preload" href="/assets/js/app.2f25c357.js" as="script"><link rel="preload" href="/assets/js/2.63c13255.js" as="script"><link rel="preload" href="/assets/js/43.2812f396.js" as="script"><link rel="prefetch" href="/assets/js/10.c7b7d24d.js"><link rel="prefetch" href="/assets/js/11.06f80eba.js"><link rel="prefetch" href="/assets/js/12.6f810a00.js"><link rel="prefetch" href="/assets/js/13.25833528.js"><link rel="prefetch" href="/assets/js/14.4b786116.js"><link rel="prefetch" href="/assets/js/15.abfc377c.js"><link rel="prefetch" href="/assets/js/16.c75b4166.js"><link rel="prefetch" href="/assets/js/17.453f868d.js"><link rel="prefetch" href="/assets/js/18.a490508f.js"><link rel="prefetch" href="/assets/js/19.80524214.js"><link rel="prefetch" href="/assets/js/20.a97ffa51.js"><link rel="prefetch" href="/assets/js/21.547ddc23.js"><link rel="prefetch" href="/assets/js/22.45e85bde.js"><link rel="prefetch" href="/assets/js/23.0dbcaa21.js"><link rel="prefetch" href="/assets/js/24.131b5686.js"><link rel="prefetch" href="/assets/js/25.3d4c262a.js"><link rel="prefetch" href="/assets/js/26.9cbfd763.js"><link rel="prefetch" href="/assets/js/27.542a2792.js"><link rel="prefetch" href="/assets/js/28.fbca4c4d.js"><link rel="prefetch" href="/assets/js/29.9eff63d9.js"><link rel="prefetch" href="/assets/js/3.174213b6.js"><link rel="prefetch" href="/assets/js/30.a6823283.js"><link rel="prefetch" href="/assets/js/31.6a4a92c8.js"><link rel="prefetch" href="/assets/js/32.ce935036.js"><link rel="prefetch" href="/assets/js/33.8771b5d9.js"><link rel="prefetch" href="/assets/js/34.6ef7ae0f.js"><link rel="prefetch" href="/assets/js/35.08fc79cf.js"><link rel="prefetch" href="/assets/js/36.181bec7a.js"><link rel="prefetch" href="/assets/js/37.4e5cdaf9.js"><link rel="prefetch" href="/assets/js/38.f6abaf38.js"><link rel="prefetch" href="/assets/js/39.bc91b61a.js"><link rel="prefetch" href="/assets/js/4.13c31685.js"><link rel="prefetch" href="/assets/js/40.0c43ce82.js"><link rel="prefetch" href="/assets/js/41.4eeb5771.js"><link rel="prefetch" href="/assets/js/42.13baee4d.js"><link rel="prefetch" href="/assets/js/44.87333552.js"><link rel="prefetch" href="/assets/js/45.79925286.js"><link rel="prefetch" href="/assets/js/46.63ec06c7.js"><link rel="prefetch" href="/assets/js/47.31484b65.js"><link rel="prefetch" href="/assets/js/48.61c835fb.js"><link rel="prefetch" href="/assets/js/49.b420b13c.js"><link rel="prefetch" href="/assets/js/5.cbba45ac.js"><link rel="prefetch" href="/assets/js/50.53f11d2b.js"><link rel="prefetch" href="/assets/js/51.1eced69f.js"><link rel="prefetch" href="/assets/js/52.cdb811f6.js"><link rel="prefetch" href="/assets/js/53.18dbb2da.js"><link rel="prefetch" href="/assets/js/54.2f8c7ead.js"><link rel="prefetch" href="/assets/js/55.c17da82b.js"><link rel="prefetch" href="/assets/js/56.ec36758b.js"><link rel="prefetch" href="/assets/js/57.639cf8a7.js"><link rel="prefetch" href="/assets/js/58.848e0216.js"><link rel="prefetch" href="/assets/js/59.89a629cb.js"><link rel="prefetch" href="/assets/js/6.8d81f0ec.js"><link rel="prefetch" href="/assets/js/60.6ee5bb23.js"><link rel="prefetch" href="/assets/js/61.778f8894.js"><link rel="prefetch" href="/assets/js/62.5b79d674.js"><link rel="prefetch" href="/assets/js/63.1f7ab42c.js"><link rel="prefetch" href="/assets/js/64.06670e46.js"><link rel="prefetch" href="/assets/js/65.d55a0cb5.js"><link rel="prefetch" href="/assets/js/66.c0d943d5.js"><link rel="prefetch" href="/assets/js/67.191b831c.js"><link rel="prefetch" href="/assets/js/68.30a1580e.js"><link rel="prefetch" href="/assets/js/69.8a91a673.js"><link rel="prefetch" href="/assets/js/7.2259505f.js"><link rel="prefetch" href="/assets/js/70.8ef61250.js"><link rel="prefetch" href="/assets/js/71.52f9a69a.js"><link rel="prefetch" href="/assets/js/72.4af68aa5.js"><link rel="prefetch" href="/assets/js/73.804ce09d.js"><link rel="prefetch" href="/assets/js/74.0dcbb650.js"><link rel="prefetch" href="/assets/js/75.ce1dff6f.js"><link rel="prefetch" href="/assets/js/76.1c3e5a54.js"><link rel="prefetch" href="/assets/js/77.f0d66982.js"><link rel="prefetch" href="/assets/js/78.436e7214.js"><link rel="prefetch" href="/assets/js/79.900d03e3.js"><link rel="prefetch" href="/assets/js/8.6b054f16.js"><link rel="prefetch" href="/assets/js/80.de0bd2c2.js"><link rel="prefetch" href="/assets/js/9.eeae1cb6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2b9f1a15.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.jpg" alt="迪" class="logo"> <span class="site-name can-hide">迪</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/back-end/java/java集合.html" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/guide/前端/JavaScript/ES6.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/guide/other/docker/Docker.html" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="https://www.baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  百度
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/chinese.html" class="nav-link">
  中文
</a></li><li class="dropdown-item"><!----> <a href="/language/english.html" class="nav-link">
  English
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/back-end/java/java集合.html" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/guide/前端/JavaScript/ES6.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/guide/other/docker/Docker.html" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="https://www.baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  百度
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/chinese.html" class="nav-link">
  中文
</a></li><li class="dropdown-item"><!----> <a href="/language/english.html" class="nav-link">
  English
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>后端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/back-end/java/java集合.html" class="sidebar-link">java集合</a></li><li><a href="/guide/back-end/java/多线程.html" class="sidebar-link">多线程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>Kubernetes</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/other/Kubernetes/1.Kubernetes部署.html" class="sidebar-link">1.Kubernetes部署</a></li><li><a href="/guide/other/Kubernetes/2-Kubernetes资源管理方式.html" class="sidebar-link">2.Kubernetes资源管理方式</a></li><li><a href="/guide/other/Kubernetes/3-Kubernetes的对象.html" class="sidebar-link">3.Kubernetes的对象</a></li><li><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html" class="sidebar-link">4.Kubernetes的Pod</a></li><li><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html" class="active sidebar-link">5.Kubernetes的控制器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_2-1-概述" class="sidebar-link">2.1 概述</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_2-2-示例" class="sidebar-link">2.2 示例</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_2-3-扩缩容" class="sidebar-link">2.3 扩缩容</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_2-4-删除replicaset" class="sidebar-link">2.4 删除ReplicaSet</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_3-1-概述" class="sidebar-link">3.1 概述</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_3-2-示例" class="sidebar-link">3.2 示例</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_3-3-扩缩容" class="sidebar-link">3.3 扩缩容</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_3-4-镜像更新" class="sidebar-link">3.4 镜像更新</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_3-5-版本回退" class="sidebar-link">3.5 版本回退</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_3-6-金丝雀发布" class="sidebar-link">3.6 金丝雀发布</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_3-7-删除deployment" class="sidebar-link">3.7 删除Deployment</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_4-1-概述" class="sidebar-link">4.1 概述</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_5-1-概述" class="sidebar-link">5.1 概述</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_5-2-示例" class="sidebar-link">5.2 示例</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_6-1-概述" class="sidebar-link">6.1 概述</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_6-2-示例" class="sidebar-link">6.2 示例</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_7-1-概述" class="sidebar-link">7.1 概述</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_7-2-示例" class="sidebar-link">7.2 示例</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_8-1-概述" class="sidebar-link">8.1 概述</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_8-2-示例" class="sidebar-link">8.2 示例</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_8-3-deployment和statefulset的区别" class="sidebar-link">8.3 Deployment和StatefulSet的区别</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html#_8-4-statefulset的金丝雀发布" class="sidebar-link">8.4 StatefulSet的金丝雀发布</a></li></ul></li><li><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html" class="sidebar-link">6.Kubernetes的Service</a></li><li><a href="/guide/other/Kubernetes/7-Kubernetes的数据存储.html" class="sidebar-link">7.Kubernetes的数据存储</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/other/Linux/Linux.html" class="sidebar-link">Linux</a></li><li><a href="/guide/other/Linux/Linux基础.html" class="sidebar-link">Linux基础</a></li><li><a href="/guide/other/Linux/Shell脚本.html" class="sidebar-link">Shell脚本</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>项目管理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/other/project-manage/git.html" class="sidebar-link">Git</a></li><li><a href="/guide/other/project-manage/maven.html" class="sidebar-link">Maven</a></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_1-概述"><a href="#_1-概述" class="header-anchor">#</a> 1 概述</h1> <p>在kubernetes中，按照Pod的创建方式可以将其分为两类：</p> <ul><li>自主式Pod：kubernetes直接创建出来的Pod，这种Pod删除后就没有了，也不会重建。</li> <li>控制器创建Pod：通过Pod控制器创建的Pod，这种Pod删除之后还会自动重建。</li></ul> <p>Pod控制器：Pod控制器是管理Pod的中间层，使用了Pod控制器之后，我们只需要告诉Pod控制器，想要多少个什么样的Pod就可以了，它就会创建出满足条件的Pod并确保每一个Pod处于用户期望的状态，如果Pod在运行中出现故障，控制器会基于指定的策略重启或重建Pod。
在kubernetes中，有很多类型的Pod控制器，每种都有自己的适合的场景，常见的有下面这些：</p> <ul><li>ReplicationController：比较原始的Pod控制器，已经被废弃，由ReplicaSet替代。</li> <li>ReplicaSet：保证指定数量的Pod运行，并支持Pod数量变更，镜像版本变更。</li> <li>Deployment：通过控制ReplicaSet来控制Pod，并支持滚动升级、版本回退。</li> <li>Horizontal Pod Autoscaler：可以根据集群负载自动调整Pod的数量，实现削峰填谷。</li> <li>DaemonSet：在集群中的指定Node上都运行一个副本，一般用于守护进程类的任务。</li> <li>Job：它创建出来的Pod只要完成任务就立即退出，用于执行一次性任务。</li> <li>CronJob：它创建的Pod会周期性的执行，用于执行周期性的任务。</li> <li>StatefulSet：管理有状态的应用。</li></ul> <h1 id="_2-replicaset-rs"><a href="#_2-replicaset-rs" class="header-anchor">#</a> 2 ReplicaSet（RS）</h1> <h2 id="_2-1-概述"><a href="#_2-1-概述" class="header-anchor">#</a> 2.1 概述</h2> <p>ReplicaSet的主要作用是保证一定数量的Pod能够正常运行，它会持续监听这些Pod的运行状态，一旦Pod发生故障，就会重启或重建。同时它还支持对Pod数量的扩缩容。
<strong>ReplicaSet的资源清单：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本号 </span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet <span class="token comment"># 类型 </span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据 </span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># 所属命名空间 </span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#标签 </span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> rs 
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述 </span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 副本数量 </span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器管理哪些po</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment"># Labels匹配规则 </span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod 
    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions匹配规则 </span>
      <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nginx<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">}</span> 
<span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本 </span>
  <span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
    <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod 
  <span class="token key atrule">spec</span><span class="token punctuation">:</span> 
    <span class="token key atrule">containers</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx 
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1 
        <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><p>在这里，需要新了解的配置项就是spec下面几个选项：</p> <ul><li>replicas：指定副本数量，其实就是当然rs创建出来的Pod的数量，默认为1.</li> <li>selector：选择器，它的作用是建立Pod控制器和Pod之间的关联关系，采用了Label Selector机制（在Pod模块上定义Label，在控制器上定义选择器，就可以表明当前控制器能管理哪些Pod了）。</li> <li>template：模板，就是当前控制器创建Pod所使用的模板，里面其实就是前面学过的Pod的定义。</li></ul> <h2 id="_2-2-示例"><a href="#_2-2-示例" class="header-anchor">#</a> 2.2 示例</h2> <p><strong>创建pc-replicaset.yaml文件：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet <span class="token comment"># 类型</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>replicaset <span class="token comment"># rs名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev <span class="token comment"># 命名类型</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详细描述</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 副本数量</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器可以管理哪些Pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment"># Labels匹配规则</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模块 当副本数据不足的时候，会根据下面的模板创建Pod副本</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment"># 容器名称</span>
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1 <span class="token comment"># 容器需要的镜像地址</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># 容器所监听的端口</span>
</code></pre></div><p><strong>查看rs：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get rs pc-replicaset <span class="token parameter variable">-n</span> <span class="token parameter variable">-dev</span> <span class="token parameter variable">-o</span> wide
</code></pre></div><h2 id="_2-3-扩缩容"><a href="#_2-3-扩缩容" class="header-anchor">#</a> 2.3 扩缩容</h2> <p>编辑rs副本数量，修改spec:replicas即可：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl edit rs pc-replicaset <span class="token parameter variable">-n</span> dev
</code></pre></div><p>使用scale命令实现扩缩容：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl scale rs pc-replicaset <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">-n</span> dev
</code></pre></div><h2 id="_2-4-删除replicaset"><a href="#_2-4-删除replicaset" class="header-anchor">#</a> 2.4 删除ReplicaSet</h2> <p>使用kubectl delete rs 命令会删除ReplicaSet和其管理的Pod。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 在kubernetes删除ReplicaSet前，会将ReplicaSet的replicas调整为0，等到所有的Pod被删除后，再执行ReplicaSet对象的删除</span>
kubectl delete rs pc-replicaset <span class="token parameter variable">-n</span> dev
</code></pre></div><p>直接使用yaml删除（推荐）：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl delete <span class="token parameter variable">-f</span> pc-replicaset.yaml
</code></pre></div><h1 id="_3-deployment-deploy"><a href="#_3-deployment-deploy" class="header-anchor">#</a> 3 Deployment（deploy）</h1> <h2 id="_3-1-概述"><a href="#_3-1-概述" class="header-anchor">#</a> 3.1 概述</h2> <p>为了更好的解决服务编排的问题，kubernetes在v1.2版本开始，引入了Deployment控制器。值得一提的是，Deployment控制器并不直接管理Pod，而是通过管理ReplicaSet来间接管理Pod，创建一个Deployment对象后，在同一个命名空间可以看到它管理的ReplicaSet对象。即：Deployment管理ReplicaSet，ReplicaSet管理Pod。所以Deployment的功能比ReplicaSet强大。
Deployment的主要功能如下：</p> <ul><li>支持ReplicaSet的所有功能。</li> <li>支持发布的停止、继续。</li> <li>支持版本滚动更新和版本回退。</li></ul> <p><strong>Deployment资源清单：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本号 </span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment <span class="token comment"># 类型 </span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据 </span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># rs名称 </span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment"># 所属命名空间 </span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#标签 </span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> deploy 
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述 </span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 副本数量 </span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 保留历史版本，默认为10 </span>
  <span class="token key atrule">paused</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># 暂停部署，默认是false </span>
  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span> <span class="token comment"># 部署超时时间（s），默认是600 </span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># 策略 </span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># 滚动更新策略 </span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span> <span class="token comment"># 滚动更新 </span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 30% <span class="token comment"># 最大额外可以存在的副本数，可以为百分比，也可以为整数 maxUnavailable: 30% # 最大不可用状态的    Pod 的最大值，可以为百分比，也可以为整数 </span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器管理哪些pod </span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment"># Labels匹配规则 </span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod 
    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions匹配规则 </span>
      <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> app<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nginx<span class="token punctuation">-</span>pod<span class="token punctuation">]</span><span class="token punctuation">}</span> 
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建pod副本 </span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
      <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod 
    <span class="token key atrule">spec</span><span class="token punctuation">:</span> 
      <span class="token key atrule">containers</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx 
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1 
        <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><h2 id="_3-2-示例"><a href="#_3-2-示例" class="header-anchor">#</a> 3.2 示例</h2> <p><strong>创建pc-deployment.yaml文件：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment <span class="token comment"># 类型</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>deployment <span class="token comment"># deployment的名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev <span class="token comment"># 命名类型</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详细描述</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 副本数量</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器可以管理哪些Pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment"># Labels匹配规则</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模块 当副本数据不足的时候，会根据下面的模板创建Pod副本</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment"># 容器名称</span>
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1 <span class="token comment"># 容器需要的镜像地址</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># 容器所监听的端口</span>
</code></pre></div><p><strong>创建Deployment：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> pc-deployment.yaml
</code></pre></div><p><strong>查看Deployment：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># UP-TO-DATE 最新版本的Pod数量</span>
<span class="token comment"># AVAILABLE 当前可用的Pod数量</span>
kubectl get deploy pc-deployment <span class="token parameter variable">-n</span> dev
</code></pre></div><p><strong>查看pod：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pod <span class="token parameter variable">-n</span> dev
</code></pre></div><h2 id="_3-3-扩缩容"><a href="#_3-3-扩缩容" class="header-anchor">#</a> 3.3 扩缩容</h2> <p>使用scale命令实现：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl scale deploy pc-deployment <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">5</span> <span class="token parameter variable">-n</span> dev
</code></pre></div><p>编辑Deployment的副本数量，修改spec:replicas即可</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl edit deployment pc-deployment <span class="token parameter variable">-n</span> dev
</code></pre></div><h2 id="_3-4-镜像更新"><a href="#_3-4-镜像更新" class="header-anchor">#</a> 3.4 镜像更新</h2> <p>Deployment支持两种镜像更新的策略：<code>重建更新</code>和<code>滚动更新（默认）</code>，可以通过<code>strategy</code>选项进行配置。
strategy: 指定新的Pod替代旧的Pod的策略，支持两个属性</p> <ul><li>type: 指定策略类型，支持两种策略
<ul><li>Recreate：在创建出新的Pod之前会先杀掉所有已经存在的Pod</li> <li>RollingUpdate：滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本的Pod</li></ul></li> <li>rollingUpdate：当type为RollingUpdate的时候生效，用于为rollingUpdate设置参数，支持两个属性：
<ul><li>maxUnavailable：用来指定在升级过程中不可用的Pod的最大数量，默认为25%。</li> <li>maxSurge： 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%。</li></ul></li></ul> <h3 id="_3-4-1-重建更新"><a href="#_3-4-1-重建更新" class="header-anchor">#</a> 3.4.1 重建更新</h3> <p><strong>编辑pc-deployment.yaml文件，在spec节点下添加更新策略：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment <span class="token comment"># 类型</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>deployment <span class="token comment"># deployment的名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev <span class="token comment"># 命名类型</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详细描述</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 副本数量</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># 镜像更新策略</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate <span class="token comment"># Recreate：在创建出新的Pod之前会先杀掉所有已经存在的Pod</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器可以管理哪些Pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment"># Labels匹配规则</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模块 当副本数据不足的时候，会根据下面的模板创建Pod副本</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment"># 容器名称</span>
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1 <span class="token comment"># 容器需要的镜像地址</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># 容器所监听的端口</span>
</code></pre></div><p><strong>升级镜像：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl <span class="token builtin class-name">set</span> image deployment pc-deployment <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.17.2 <span class="token parameter variable">-n</span> dev
</code></pre></div><p><strong>查看升级过程</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pod <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-w</span>
</code></pre></div><h3 id="_3-4-2-滚动更新"><a href="#_3-4-2-滚动更新" class="header-anchor">#</a> 3.4.2 滚动更新</h3> <p><strong>编辑pc-deployment.yaml文件，在spec节点下添加更新策略：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment <span class="token comment"># 类型</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>deployment <span class="token comment"># deployment的名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev <span class="token comment"># 命名类型</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详细描述</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 副本数量</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token comment"># 镜像更新策略</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># RollingUpdate：滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本的Pod</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器可以管理哪些Pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment"># Labels匹配规则</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模块 当副本数据不足的时候，会根据下面的模板创建Pod副本</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment"># 容器名称</span>
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1 <span class="token comment"># 容器需要的镜像地址</span>
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># 容器所监听的端口</span>
</code></pre></div><p><strong>升级镜像</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl <span class="token builtin class-name">set</span> image deployment pc-deployment <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.17.3 <span class="token parameter variable">-n</span> dev
</code></pre></div><p><strong>查看升级过程</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pod <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-w</span>
</code></pre></div><p><strong>镜像更新中查看rs的变化</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 查看rs，发现原来的rs依旧存在，只是Pod的数量变为0，而后又产生了一个rs，Pod的数量变为3</span>
<span class="token comment"># 其实这就是deployment能够进行版本回退的奥妙所在</span>
kubectl get rs <span class="token parameter variable">-n</span> dev
</code></pre></div><h2 id="_3-5-版本回退"><a href="#_3-5-版本回退" class="header-anchor">#</a> 3.5 版本回退</h2> <p>Deployment支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能，下面具体来看：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 版本升级相关功能</span>
kubetl rollout 参数 deploy xx  <span class="token comment"># 支持下面的选择</span>
<span class="token comment"># status 显示当前升级的状态</span>
<span class="token comment"># history 显示升级历史记录</span>
<span class="token comment"># pause 暂停版本升级过程</span>
<span class="token comment"># resume 继续已经暂停的版本升级过程</span>
<span class="token comment"># restart 重启版本升级过程</span>
<span class="token comment"># undo 回滚到上一级版本 （可以使用--to-revision回滚到指定的版本）</span>
</code></pre></div><h3 id="_3-5-1-查看当前升级版本状态"><a href="#_3-5-1-查看当前升级版本状态" class="header-anchor">#</a> 3.5.1 查看当前升级版本状态</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl rollout status deployment pc-deployment <span class="token parameter variable">-n</span> dev
</code></pre></div><h3 id="_3-5-2-查看升级历史记录"><a href="#_3-5-2-查看升级历史记录" class="header-anchor">#</a> 3.5.2 查看升级历史记录</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl rollout <span class="token function">history</span> deployment pc-deployment <span class="token parameter variable">-n</span> dev
</code></pre></div><h3 id="_3-5-3-版本回退"><a href="#_3-5-3-版本回退" class="header-anchor">#</a> 3.5.3 版本回退</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 可以使用-to-revision=1回退到1版本，如果省略这个选项，就是回退到上个版本，即2版本</span>
kubectl rollout undo deployment pc-deployment --to-revision<span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">-n</span> dev
</code></pre></div><h2 id="_3-6-金丝雀发布"><a href="#_3-6-金丝雀发布" class="header-anchor">#</a> 3.6 金丝雀发布</h2> <p>Deployment支持更新过程中的控制，如暂停更新操作（pause）或继续更新操作（resume）。
例如有一批新的Pod资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，再筛选一小部分的用户请求到新版本的Pod应用，继续观察能够稳定的按照期望的方式运行，如果没有问题之后再继续完成余下的Pod资源的滚动更新，否则立即回滚操作。
<strong>更新Deployment的版本，并配置暂停Deployment：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl <span class="token builtin class-name">set</span> image deployment pc-deployment <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.17.4 <span class="token parameter variable">-n</span> dev <span class="token operator">&amp;&amp;</span> kubectl rollout pause deployment pc-deployment <span class="token parameter variable">-n</span> dev
</code></pre></div><p><strong>观察更新状态：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl rollout status deployment pc-deployment <span class="token parameter variable">-n</span> dev
</code></pre></div><p>监控更新的过程，可以看到已经新增了一个资源，但是并没有按照预期的状态去删除一个旧的资源，因为使用了pause暂停命令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get rs <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-o</span> wide
</code></pre></div><p><strong>确保新的pod没有问题之后，继续更新：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl rollout resume deployment pc-deployment <span class="token parameter variable">-n</span> dev
</code></pre></div><h2 id="_3-7-删除deployment"><a href="#_3-7-删除deployment" class="header-anchor">#</a> 3.7 删除Deployment</h2> <p>删除Deployment，其管理的ReplicaSet和pod也会被一起删除：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl delete <span class="token parameter variable">-f</span> pc-deployment.yaml
</code></pre></div><h1 id="_4-horizontal-pod-autoscaler-hpa"><a href="#_4-horizontal-pod-autoscaler-hpa" class="header-anchor">#</a> 4 Horizontal Pod Autoscaler（HPA）</h1> <h2 id="_4-1-概述"><a href="#_4-1-概述" class="header-anchor">#</a> 4.1 概述</h2> <p>我们已经可以通过手动执行<code>kubectl scale</code>命令实现Pod的扩缩容，但是这显然不符合kubernetes的定位目标–自动化和智能化。kubernetes期望可以通过监测Pod的使用情况，实现Pod数量的自动调整，于是就产生了HPA这种控制器。
HPA可以获取每个Pod的利用率，然后和HPA中定义的指标进行对比，同时计算出需要伸缩的具体值，最后实现Pod的数量的调整。其实HPA和之前的Deployment一样，也属于一种kubernetes资源对象，它通过追踪分析目标Pod的负载变化情况，来确定是否需要针对性的调整目标Pod的副本数。
HPA通过Deployment对象来动态调整。</p> <h1 id="_5-daemonset-ds"><a href="#_5-daemonset-ds" class="header-anchor">#</a> 5 DaemonSet（DS）</h1> <h2 id="_5-1-概述"><a href="#_5-1-概述" class="header-anchor">#</a> 5.1 概述</h2> <p>DaemonSet类型的控制器可以保证集群中的每一台（或指定）节点上都运行一个副本，一般适用于日志收集、节点监控等场景。也就是说，如果一个Pod提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类Pod就适合使用DaemonSet类型的控制器创建。
DaemonSet控制器的特点：</p> <ul><li>每向集群中添加一个节点的时候，指定的Pod副本也将添加到该节点上。</li> <li>当节点从集群中移除的时候，Pod也会被垃圾回收。</li></ul> <p><strong>DaemonSet资源清单：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet <span class="token comment"># 类型</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token comment"># 名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token comment">#命名空间</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment">#标签</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> daemonset
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 保留历史版本</span>
  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span> <span class="token comment"># 更新策略</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate <span class="token comment"># 滚动更新策略</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span> <span class="token comment"># 滚动更新</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 最大不可用状态的Pod的最大值，可用为百分比，也可以为整数</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器管理那些Pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment"># Labels匹配规则</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions匹配规则</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app
        <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
        <span class="token key atrule">values</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
     <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
     <span class="token key atrule">spec</span><span class="token punctuation">:</span>
       <span class="token key atrule">containers</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
           <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
           <span class="token key atrule">ports</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><h2 id="_5-2-示例"><a href="#_5-2-示例" class="header-anchor">#</a> 5.2 示例</h2> <p><strong>创建pc-daemonset.yaml文件：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet <span class="token comment"># 类型</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>damonset <span class="token comment"># 名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev <span class="token comment">#命名空间</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器管理那些Pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment"># Labels匹配规则</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
     <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
     <span class="token key atrule">spec</span><span class="token punctuation">:</span>
       <span class="token key atrule">containers</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
           <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
           <span class="token key atrule">ports</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><p><strong>查看DaemonSet：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get ds <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-o</span> wide
</code></pre></div><p><strong>删除DaemonSet：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl delete ds pc-damonset <span class="token parameter variable">-n</span> dev
</code></pre></div><h1 id="_6-job"><a href="#_6-job" class="header-anchor">#</a> 6 Job</h1> <h2 id="_6-1-概述"><a href="#_6-1-概述" class="header-anchor">#</a> 6.1 概述</h2> <p>Job主要用于负责批量处理短暂的一次性任务。
Job的特点：</p> <ul><li>当Job创建的Pod执行成功结束时，Job将记录成功结束的Pod数量。</li> <li>当成功结束的Pod达到指定的数量时，Job将完成执行。</li></ul> <p><strong>Job的资源清单：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job <span class="token comment"># 类型</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span>  <span class="token comment"># 名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span>  <span class="token comment">#命名空间</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment"># 标签</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> job
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span>
  <span class="token key atrule">completions</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 指定Job需要成功运行Pod的总次数，默认为1</span>
  <span class="token key atrule">parallelism</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 指定Job在任一时刻应该并发运行Pod的数量，默认为1</span>
  <span class="token key atrule">activeDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span> <span class="token comment"># 指定Job可以运行的时间期限，超过时间还没结束，系统将会尝试进行终止</span>
  <span class="token key atrule">backoffLimit</span><span class="token punctuation">:</span> <span class="token number">6</span> <span class="token comment"># 指定Job失败后进行重试的次数，默认为6</span>
  <span class="token key atrule">manualSelector</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否可以使用selector选择器选择Pod，默认为false</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器管理那些Pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment"># Labels匹配规则</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># Expressions匹配规则</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app
        <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
        <span class="token key atrule">values</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> counter<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
     <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
     <span class="token key atrule">spec</span><span class="token punctuation">:</span>
       <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never <span class="token comment"># 重启策略只能设置为Never或OnFailure</span>
       <span class="token key atrule">containers</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter
           <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
           <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 20;done&quot;</span><span class="token punctuation">]</span>
</code></pre></div><blockquote><p>关于模板中的重启策略的说明：</p> <ul><li>如果设置为OnFailure，则Job会在Pod出现故障的时候重启容器，而不是创建Pod，failed次数不变。</li> <li>如果设置为Never，则Job会在Pod出现故障的时候创建新的Pod，并且故障Pod不会消失，也不会重启，failed次数+1。</li> <li>如果指定为Always的话，就意味着一直重启，意味着Pod任务会重复执行，这和Job的定义冲突，所以不能设置为Always。</li></ul></blockquote> <h2 id="_6-2-示例"><a href="#_6-2-示例" class="header-anchor">#</a> 6.2 示例</h2> <p><strong>创建pc-job.yaml文件：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Job <span class="token comment"># 类型</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>job <span class="token comment"># 名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev <span class="token comment">#命名空间</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span>
  <span class="token key atrule">manualSelector</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 是否可以使用selector选择器选择Pod，默认为false</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token comment"># 选择器，通过它指定该控制器管理那些Pod</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span> <span class="token comment"># Labels匹配规则</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> counter<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never <span class="token comment"># 重启策略只能设置为Never或OnFailure</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter
          <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 3;done&quot;</span> <span class="token punctuation">]</span>
</code></pre></div><p><strong>查看job：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get job <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-w</span>
</code></pre></div><p><strong>查看pod：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pod <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-w</span>
</code></pre></div><p><strong>删除job：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl delete <span class="token parameter variable">-f</span> pc-job.yaml
</code></pre></div><h1 id="_7-cornjob-cj"><a href="#_7-cornjob-cj" class="header-anchor">#</a> 7 CornJob(CJ)</h1> <h2 id="_7-1-概述"><a href="#_7-1-概述" class="header-anchor">#</a> 7.1 概述</h2> <p>CronJob控制器以Job控制器为其管控对象，并借助它管理Pod资源对象，Job控制器定义的作业任务在其控制器资源创建之后便会立即执行，但CronJob可以以类似Linux操作系统的周期性任务作业计划的方式控制器运行时间点及重复运行的方式，换言之，CronJob可以在特定的时间点反复去执行Job任务。
<strong>CronJob的资源清单：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob <span class="token comment"># 类型</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span>  <span class="token comment"># 名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span>  <span class="token comment">#命名空间</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">controller</span><span class="token punctuation">:</span> cronjob
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token comment"># cron格式的作业调度运行时间点，用于控制任务任务时间执行</span>
  <span class="token key atrule">concurrencyPolicy</span><span class="token punctuation">:</span> <span class="token comment"># 并发执行策略</span>
  <span class="token key atrule">failedJobsHistoryLimit</span><span class="token punctuation">:</span> <span class="token comment"># 为失败的任务执行保留的历史记录数，默认为1</span>
  <span class="token key atrule">successfulJobsHistoryLimit</span><span class="token punctuation">:</span> <span class="token comment"># 为成功的任务执行保留的历史记录数，默认为3</span>
  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span> <span class="token comment"># job控制器模板，用于为cronjob控制器生成job对象，下面其实就是job的定义</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">completions</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 指定Job需要成功运行Pod的总次数，默认为1</span>
      <span class="token key atrule">parallelism</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># 指定Job在任一时刻应该并发运行Pod的数量，默认为1</span>
      <span class="token key atrule">activeDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span> <span class="token comment"># 指定Job可以运行的时间期限，超过时间还没结束，系统将会尝试进行终止</span>
      <span class="token key atrule">backoffLimit</span><span class="token punctuation">:</span> <span class="token number">6</span> <span class="token comment"># 指定Job失败后进行重试的次数，默认为6</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never <span class="token comment"># 重启策略只能设置为Never或OnFailure</span>
          <span class="token key atrule">containers</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter
              <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 20;done&quot;</span> <span class="token punctuation">]</span>
</code></pre></div><blockquote><p>schedule：cron表达式，用于指定任务的执行时间。</p> <ul><li>_/1  _  _  _  *：表示分钟  小时  日  月份  星期。</li> <li>分钟的值从0到59。</li> <li>小时的值从0到23。</li> <li>日的值从1到31。</li> <li>月的值从1到12。</li> <li>星期的值从0到6，0表示星期日。</li> <li>多个时间可以用逗号隔开，范围可以用连字符给出：* 可以作为通配符，/表示每...</li></ul></blockquote> <p>concurrencyPolicy：并发执行策略</p> <blockquote><ul><li>Allow：运行Job并发运行（默认）。</li> <li>Forbid：禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行。</li> <li>Replace：替换，取消当前正在运行的作业并使用新作业替换它。</li></ul></blockquote> <h2 id="_7-2-示例"><a href="#_7-2-示例" class="header-anchor">#</a> 7.2 示例</h2> <p><strong>创建pc-cronjob.yaml文件：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1 <span class="token comment"># 版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob <span class="token comment"># 类型</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment"># 元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>cronjob <span class="token comment"># 名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev  <span class="token comment">#命名空间</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment"># 详情描述</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">&quot;*/1 * * * * &quot;</span> <span class="token comment"># cron格式的作业调度运行时间点，用于控制任务任务时间执行</span>
  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span> <span class="token comment"># job控制器模板，用于为cronjob控制器生成job对象，下面其实就是job的定义</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># 模板，当副本数量不足时，会根据下面的模板创建Pod模板</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never <span class="token comment"># 重启策略只能设置为Never或OnFailure</span>
          <span class="token key atrule">containers</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> counter
              <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;for i in 9 8 7 6 5 4 3 2 1;do echo $i;sleep 2;done&quot;</span> <span class="token punctuation">]</span>
</code></pre></div><h1 id="_8-statefulset-有状态"><a href="#_8-statefulset-有状态" class="header-anchor">#</a> 8 StatefulSet(有状态)</h1> <h2 id="_8-1-概述"><a href="#_8-1-概述" class="header-anchor">#</a> 8.1 概述</h2> <p>无状态应用：</p> <ul><li>认为Pod都是一样的。</li> <li>没有顺序要求。</li> <li>不用考虑在哪个Node节点上运行。</li> <li>随意进行伸缩和扩展。</li></ul> <p>有状态应用：</p> <ul><li>有顺序的要求。</li> <li>认为每个Pod都是不一样的。</li> <li>需要考虑在哪个Node节点上运行。</li> <li>需要按照顺序进行伸缩和扩展。</li> <li>让每个Pod都是独立的，保持Pod启动顺序和唯一性。</li></ul> <p>StatefulSet是Kubernetes提供的管理有状态应用的负载管理控制器。
StatefulSet部署需要HeadLinessService（无头服务）。</p> <blockquote><p>为什么需要HeadLinessService（无头服务）？</p> <ul><li>在用Deployment时，每一个Pod名称是没有顺序的，是随机字符串，因此是Pod名称是无序的，但是在StatefulSet中要求必须是有序 ，每一个Pod不能被随意取代，Pod重建后pod名称还是一样的。</li> <li>而Pod IP是变化的，所以是以Pod名称来识别。Pod名称是Pod唯一性的标识符，必须持久稳定有效。这时候要用到无头服务，它可以给每个Pod一个唯一的名称 。</li></ul></blockquote> <p>StatefulSet常用来部署RabbitMQ集群、Zookeeper集群、MySQL集群、Eureka集群等。</p> <h2 id="_8-2-示例"><a href="#_8-2-示例" class="header-anchor">#</a> 8.2 示例</h2> <p><strong>创建pc-stateful.yaml文件：</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>headliness
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None <span class="token comment"># 将clusterIP设置为None，即可创建headliness Service</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># Service的端口</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># Pod的端口</span>
<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pc<span class="token punctuation">-</span>statefulset
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>headliness
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>pod
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><p><strong>创建StatefulSet：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create <span class="token parameter variable">-f</span> pc-stateful.yaml
</code></pre></div><p><strong>查看StatefulSet：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get statefulset pc-statefulset <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-o</span> wide
</code></pre></div><p><strong>查看Pod：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pod <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-o</span> wide
</code></pre></div><p><strong>删除StatefulSet：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl delete <span class="token parameter variable">-f</span> pc-stateful.yaml
</code></pre></div><h2 id="_8-3-deployment和statefulset的区别"><a href="#_8-3-deployment和statefulset的区别" class="header-anchor">#</a> 8.3 Deployment和StatefulSet的区别</h2> <p>Deployment和StatefulSet的区别：<strong>Deployment没有唯一标识而StatefulSet有唯一标识。</strong>
StatefulSet的唯一标识是根据主机名+一定规则生成的。StatefulSet的唯一标识是<code>主机名.无头Service名称.命名空间.svc.cluster.local</code>。</p> <h2 id="_8-4-statefulset的金丝雀发布"><a href="#_8-4-statefulset的金丝雀发布" class="header-anchor">#</a> 8.4 StatefulSet的金丝雀发布</h2> <h3 id="_8-4-1-概述"><a href="#_8-4-1-概述" class="header-anchor">#</a> 8.4.1 概述</h3> <p>StatefulSet支持两种更新策略：OnDelete和RollingUpdate（默认），其中OnDelete表示删除之后才更新，RollingUpdate表示滚动更新。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>
  <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span> <span class="token comment"># 如果更新的策略是OnDelete，那么rollingUpdate就失效</span>
    <span class="token key atrule">partition</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># 表示从第2个分区开始更新，默认是0</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate /OnDelete <span class="token comment"># 滚动更新</span>
</code></pre></div><h3 id="_8-4-2-示例"><a href="#_8-4-2-示例" class="header-anchor">#</a> 8.4.2 示例</h3> <p><strong>修改pc-statefulset.yaml文件：</strong></p> <div class="language-shell extra-class"><pre class="language-shell"><code>apiVersion: v1
kind: Service
metadata:
  name: service-headliness
  namespace: dev
spec:
  selector:
    app: nginx-pod
  clusterIP: None <span class="token comment"># 将clusterIP设置为None，即可创建headliness Service</span>
  type: ClusterIP
  ports:
    - port: <span class="token number">80</span> <span class="token comment"># Service的端口</span>
      targetPort: <span class="token number">80</span> <span class="token comment"># Pod的端口</span>
---

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: pc-statefulset
  namespace: dev
spec:
  replicas: <span class="token number">3</span>
  serviceName: service-headliness
  selector:
    matchLabels:
      app: nginx-pod
  template:
    metadata:
      labels:
        app: nginx-pod
    spec:
      containers:
        - name: nginx
          image: nginx:1.17.1
          ports:
            - containerPort: <span class="token number">80</span>
			
  updateStrategy:
    rollingUpdate:
      partition: <span class="token number">0</span>
    type: RollingUpdate
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html" class="prev">
        4.Kubernetes的Pod
      </a></span> <span class="next"><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html">
        6.Kubernetes的Service
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2f25c357.js" defer></script><script src="/assets/js/2.63c13255.js" defer></script><script src="/assets/js/43.2812f396.js" defer></script>
  </body>
</html>
