<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>1 概述 | 迪</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.jpg">
    <meta name="description" content="迪的文档">
    
    <link rel="preload" href="/assets/css/0.styles.d6ad21ed.css" as="style"><link rel="preload" href="/assets/js/app.7bd49d80.js" as="script"><link rel="preload" href="/assets/js/2.63c13255.js" as="script"><link rel="preload" href="/assets/js/63.d5389af7.js" as="script"><link rel="prefetch" href="/assets/js/10.3494fc42.js"><link rel="prefetch" href="/assets/js/11.729c2ddc.js"><link rel="prefetch" href="/assets/js/12.2cbdbb2e.js"><link rel="prefetch" href="/assets/js/13.d9240596.js"><link rel="prefetch" href="/assets/js/14.482de4d9.js"><link rel="prefetch" href="/assets/js/15.5aafb57e.js"><link rel="prefetch" href="/assets/js/16.d8b25bdc.js"><link rel="prefetch" href="/assets/js/17.c59992e9.js"><link rel="prefetch" href="/assets/js/18.84364966.js"><link rel="prefetch" href="/assets/js/19.a2c00930.js"><link rel="prefetch" href="/assets/js/20.a708eb81.js"><link rel="prefetch" href="/assets/js/21.43accc43.js"><link rel="prefetch" href="/assets/js/22.f62a2950.js"><link rel="prefetch" href="/assets/js/23.34d0cd46.js"><link rel="prefetch" href="/assets/js/24.5338688c.js"><link rel="prefetch" href="/assets/js/25.49e53738.js"><link rel="prefetch" href="/assets/js/26.16ae9f2c.js"><link rel="prefetch" href="/assets/js/27.3a6d8ae8.js"><link rel="prefetch" href="/assets/js/28.c1d13fc9.js"><link rel="prefetch" href="/assets/js/29.6f2861b0.js"><link rel="prefetch" href="/assets/js/3.8a8baccb.js"><link rel="prefetch" href="/assets/js/30.e84371ac.js"><link rel="prefetch" href="/assets/js/31.5c72212f.js"><link rel="prefetch" href="/assets/js/32.6363355b.js"><link rel="prefetch" href="/assets/js/33.480aa18e.js"><link rel="prefetch" href="/assets/js/34.214d5115.js"><link rel="prefetch" href="/assets/js/35.e451acf7.js"><link rel="prefetch" href="/assets/js/36.40754204.js"><link rel="prefetch" href="/assets/js/37.c0669722.js"><link rel="prefetch" href="/assets/js/38.d21aec47.js"><link rel="prefetch" href="/assets/js/39.715eeabf.js"><link rel="prefetch" href="/assets/js/4.94733d25.js"><link rel="prefetch" href="/assets/js/40.11a9a769.js"><link rel="prefetch" href="/assets/js/41.36768ce0.js"><link rel="prefetch" href="/assets/js/42.ee1e0159.js"><link rel="prefetch" href="/assets/js/43.020fd64f.js"><link rel="prefetch" href="/assets/js/44.0c53e18b.js"><link rel="prefetch" href="/assets/js/45.4f3ef7b5.js"><link rel="prefetch" href="/assets/js/46.d9cdb5f2.js"><link rel="prefetch" href="/assets/js/47.1adb3d38.js"><link rel="prefetch" href="/assets/js/48.610e96d6.js"><link rel="prefetch" href="/assets/js/49.55d8c57f.js"><link rel="prefetch" href="/assets/js/5.2ea06e07.js"><link rel="prefetch" href="/assets/js/50.6ebf433b.js"><link rel="prefetch" href="/assets/js/51.7c6b8f90.js"><link rel="prefetch" href="/assets/js/52.272766fb.js"><link rel="prefetch" href="/assets/js/53.376bcdaa.js"><link rel="prefetch" href="/assets/js/54.64b22200.js"><link rel="prefetch" href="/assets/js/55.88f31c2d.js"><link rel="prefetch" href="/assets/js/56.adf8ff90.js"><link rel="prefetch" href="/assets/js/57.aef54518.js"><link rel="prefetch" href="/assets/js/58.3fd47dd4.js"><link rel="prefetch" href="/assets/js/59.517e8369.js"><link rel="prefetch" href="/assets/js/6.8d81f0ec.js"><link rel="prefetch" href="/assets/js/60.e18cfb4f.js"><link rel="prefetch" href="/assets/js/61.cc67b7d0.js"><link rel="prefetch" href="/assets/js/62.b85288fb.js"><link rel="prefetch" href="/assets/js/64.07e60b5f.js"><link rel="prefetch" href="/assets/js/65.aa0ff0bb.js"><link rel="prefetch" href="/assets/js/66.8e29c5d3.js"><link rel="prefetch" href="/assets/js/67.4c0457e3.js"><link rel="prefetch" href="/assets/js/68.4a42bf9a.js"><link rel="prefetch" href="/assets/js/69.8615447c.js"><link rel="prefetch" href="/assets/js/7.2259505f.js"><link rel="prefetch" href="/assets/js/70.868370f7.js"><link rel="prefetch" href="/assets/js/71.c2d2d815.js"><link rel="prefetch" href="/assets/js/72.632399c5.js"><link rel="prefetch" href="/assets/js/73.32018efb.js"><link rel="prefetch" href="/assets/js/74.f9c48ad4.js"><link rel="prefetch" href="/assets/js/75.50fefe6a.js"><link rel="prefetch" href="/assets/js/76.ccc13674.js"><link rel="prefetch" href="/assets/js/77.59a643be.js"><link rel="prefetch" href="/assets/js/78.fe57d4be.js"><link rel="prefetch" href="/assets/js/79.900d03e3.js"><link rel="prefetch" href="/assets/js/8.8a6f0706.js"><link rel="prefetch" href="/assets/js/80.de0bd2c2.js"><link rel="prefetch" href="/assets/js/9.b3b9c71b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d6ad21ed.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.jpg" alt="迪" class="logo"> <span class="site-name can-hide">迪</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/back-end/java/java集合.html" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/guide/前端/JavaScript/ES6.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/guide/other/docker/Docker.html" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="https://www.baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  百度
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/chinese.html" class="nav-link">
  中文
</a></li><li class="dropdown-item"><!----> <a href="/language/english.html" class="nav-link">
  English
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/guide/back-end/java/java集合.html" class="nav-link">
  后端
</a></div><div class="nav-item"><a href="/guide/前端/JavaScript/ES6.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/guide/other/docker/Docker.html" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="https://www.baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  百度
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/language/chinese.html" class="nav-link">
  中文
</a></li><li class="dropdown-item"><!----> <a href="/language/english.html" class="nav-link">
  English
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>后端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/back-end/java/java集合.html" class="sidebar-link">java集合</a></li><li><a href="/guide/back-end/java/多线程.html" class="sidebar-link">多线程</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>Kubernetes</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/other/Kubernetes/1.Kubernetes部署.html" class="sidebar-link">1.Kubernetes部署</a></li><li><a href="/guide/other/Kubernetes/2-Kubernetes资源管理方式.html" class="sidebar-link">2.Kubernetes资源管理方式</a></li><li><a href="/guide/other/Kubernetes/3-Kubernetes的对象.html" class="sidebar-link">3.Kubernetes的对象</a></li><li><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html" class="active sidebar-link">4.Kubernetes的Pod</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_1-概述" class="sidebar-link">1 概述</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_2-pod的定义" class="sidebar-link">2 Pod的定义</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_3-pod的配置" class="sidebar-link">3 Pod的配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_3-1-基本配置" class="sidebar-link">3.1 基本配置</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_3-2-镜像拉取策略" class="sidebar-link">3.2 镜像拉取策略</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_3-3-启动命令" class="sidebar-link">3.3 启动命令</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_3-4-环境变量" class="sidebar-link">3.4 环境变量</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_3-5-端口设置" class="sidebar-link">3.5 端口设置</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_3-6-资源配额" class="sidebar-link">3.6 资源配额</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_4-pod的生命周期" class="sidebar-link">4 Pod的生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_4-1-概述" class="sidebar-link">4.1 概述</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_4-2-创建和终止" class="sidebar-link">4.2 创建和终止</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_4-3-初始化容器" class="sidebar-link">4.3 初始化容器</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_4-4-钩子函数" class="sidebar-link">4.4 钩子函数</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_4-5-容器探测" class="sidebar-link">4.5 容器探测</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_4-6-重启策略" class="sidebar-link">4.6 重启策略</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_5-pod的调度" class="sidebar-link">5 Pod的调度</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_5-1-定向调度" class="sidebar-link">5.1 定向调度</a></li><li class="sidebar-sub-header"><a href="/guide/other/Kubernetes/4-Kubernetes的Pod.html#_5-2-亲和性调度" class="sidebar-link">5.2 亲和性调度</a></li></ul></li></ul></li><li><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html" class="sidebar-link">5.Kubernetes的控制器</a></li><li><a href="/guide/other/Kubernetes/6-Kubernetes的Service.html" class="sidebar-link">6.Kubernetes的Service</a></li><li><a href="/guide/other/Kubernetes/7-Kubernetes的数据存储.html" class="sidebar-link">7.Kubernetes的数据存储</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/other/Linux/Linux.html" class="sidebar-link">Linux</a></li><li><a href="/guide/other/Linux/Linux基础.html" class="sidebar-link">Linux基础</a></li><li><a href="/guide/other/Linux/Shell脚本.html" class="sidebar-link">Shell脚本</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading"><span>项目管理</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/other/project-manage/git.html" class="sidebar-link">Git</a></li><li><a href="/guide/other/project-manage/maven.html" class="sidebar-link">Maven</a></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_1-概述"><a href="#_1-概述" class="header-anchor">#</a> 1 概述</h2> <p>Pod是一组容器的集合（Pod就像是豌豆荚，容器就是豌豆荚中的豌豆）。这些容器共享存储、网络。实际开发中，我们一般不直接创建Pod，而是创建一个工作负载（例如：Deployment）来创建Pod。</p> <h2 id="_2-pod的定义"><a href="#_2-pod的定义" class="header-anchor">#</a> 2 Pod的定义</h2> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1     <span class="token comment">#必选，版本号，例如v1</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod       　 <span class="token comment">#必选，资源类型，例如 Pod</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>       　 <span class="token comment">#必选，元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> string     <span class="token comment">#必选，Pod名称</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> string  <span class="token comment">#Pod所属的命名空间,默认为&quot;default&quot;</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>       　　  <span class="token comment">#自定义标签列表</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string      　          
<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token comment">#必选，Pod中容器的详细定义</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token comment">#必选，Pod中容器列表</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string   <span class="token comment">#必选，容器名称</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> string  <span class="token comment">#必选，容器的镜像名称</span>
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> Always<span class="token punctuation">|</span>Never<span class="token punctuation">|</span>IfNotPresent <span class="token punctuation">]</span>  <span class="token comment">#获取镜像的策略 </span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>string<span class="token punctuation">]</span>   <span class="token comment">#容器的启动命令列表，如不指定，使用打包时使用的启动命令</span>
    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>string<span class="token punctuation">]</span>      <span class="token comment">#容器的启动命令参数列表</span>
    <span class="token key atrule">workingDir</span><span class="token punctuation">:</span> string  <span class="token comment">#容器的工作目录</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>       <span class="token comment">#挂载到容器内部的存储卷配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string      <span class="token comment">#引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名</span>
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> string <span class="token comment">#存储卷在容器内mount的绝对路径，应少于512字符</span>
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> boolean <span class="token comment">#是否为只读模式</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment">#需要暴露的端口库号列表</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string        <span class="token comment">#端口的名称</span>
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> int  <span class="token comment">#容器需要监听的端口号</span>
      <span class="token key atrule">hostPort</span><span class="token punctuation">:</span> int       <span class="token comment">#容器所在主机需要监听的端口号，默认与Container相同</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> string    <span class="token comment">#端口协议，支持TCP和UDP，默认TCP</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>   <span class="token comment">#容器运行前需设置的环境变量列表</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string  <span class="token comment">#环境变量名称</span>
      <span class="token key atrule">value</span><span class="token punctuation">:</span> string <span class="token comment">#环境变量的值</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment">#资源限制和请求的设置</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>  <span class="token comment">#资源限制的设置</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> string     <span class="token comment">#Cpu的限制，单位为core数，将用于docker run --cpu-shares参数</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> string  <span class="token comment">#内存限制，单位可以为Mib/Gib，将用于docker run --memory参数</span>
      <span class="token key atrule">requests</span><span class="token punctuation">:</span> <span class="token comment">#资源请求的设置</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> string    <span class="token comment">#Cpu请求，容器启动的初始可用数量</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> string <span class="token comment">#内存请求,容器启动的初始可用数量</span>
    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span> <span class="token comment">#生命周期钩子</span>
		<span class="token key atrule">postStart</span><span class="token punctuation">:</span> <span class="token comment">#容器启动后立即执行此钩子,如果执行失败,会根据重启策略进行重启</span>
		<span class="token key atrule">preStop</span><span class="token punctuation">:</span> <span class="token comment">#容器终止前执行此钩子,无论结果如何,容器都会终止</span>
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>  <span class="token comment">#对Pod内各容器健康检查的设置，当探测无响应几次后将自动重启该容器</span>
      <span class="token key atrule">exec</span><span class="token punctuation">:</span>       　 <span class="token comment">#对Pod容器内检查方式设置为exec方式</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>string<span class="token punctuation">]</span>  <span class="token comment">#exec方式需要制定的命令或脚本</span>
      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>       <span class="token comment">#对Pod内个容器健康检查方法设置为HttpGet，需要制定Path、port</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> string
        <span class="token key atrule">port</span><span class="token punctuation">:</span> number
        <span class="token key atrule">host</span><span class="token punctuation">:</span> string
        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> string
        <span class="token key atrule">HttpHeaders</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string
          <span class="token key atrule">value</span><span class="token punctuation">:</span> string
      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>     <span class="token comment">#对Pod内个容器健康检查方式设置为tcpSocket方式</span>
         <span class="token key atrule">port</span><span class="token punctuation">:</span> number
       <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">0</span>       <span class="token comment">#容器启动完成后首次探测的时间，单位为秒</span>
       <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> 0    　　    <span class="token comment">#对容器健康检查探测等待响应的超时时间，单位秒，默认1秒</span>
       <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> 0     　　    <span class="token comment">#对容器监控检查的定期探测时间设置，单位秒，默认10秒一次</span>
       <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">0</span>
       <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">0</span>
       <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
         <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>Always <span class="token punctuation">|</span> Never <span class="token punctuation">|</span> OnFailure<span class="token punctuation">]</span>  <span class="token comment">#Pod的重启策略</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> &lt;string<span class="token punctuation">&gt;</span> <span class="token comment">#设置NodeName表示将该Pod调度到指定到名称的node节点上</span>
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> obeject <span class="token comment">#设置NodeSelector表示将该Pod调度到包含这个label的node上</span>
  <span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span> <span class="token comment">#Pull镜像时使用的secret名称，以key：secretkey格式指定</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>   <span class="token comment">#是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>   <span class="token comment">#在该pod上定义共享存储卷列表</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> string    <span class="token comment">#共享存储卷名称 （volumes类型有很多种）</span>
    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>       <span class="token comment">#类型为emtyDir的存储卷，与Pod同生命周期的一个临时目录。为空值</span>
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span> string   <span class="token comment">#类型为hostPath的存储卷，表示挂载Pod所在宿主机的目录</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> string      　　        <span class="token comment">#Pod所在宿主机的目录，将被用于同期中mount的目录</span>
    <span class="token key atrule">secret</span><span class="token punctuation">:</span>       　　　<span class="token comment">#类型为secret的存储卷，挂载集群与定义的secret对象到容器内部</span>
      <span class="token key atrule">scretname</span><span class="token punctuation">:</span> string  
      <span class="token key atrule">items</span><span class="token punctuation">:</span>     
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> string
        <span class="token key atrule">path</span><span class="token punctuation">:</span> string
    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>         <span class="token comment">#类型为configMap的存储卷，挂载预定义的configMap对象到容器内部</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> string
      <span class="token key atrule">items</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> string
        <span class="token key atrule">path</span><span class="token punctuation">:</span> string
</code></pre></div><p>我们可以使用<code>explain</code>查看每种资源的可配置项：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># kubectl explain 资源类型</span>
kubectl explain pod
<span class="token comment"># kubectl explain 资源类型.属性</span>
kubectl explain pod.metadata
</code></pre></div><h2 id="_3-pod的配置"><a href="#_3-pod的配置" class="header-anchor">#</a> 3 Pod的配置</h2> <p>pod.spec.containers属性是pod配置中最关键的一项配置。使用<code>kubectl explain pod.spec.containers</code>查看可选配置项。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 返回的重要属性</span>
KIND:     Pod
VERSION:  v1
RESOURCE: containers <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token operator">&gt;</span>   <span class="token comment"># 数组，代表可以有多个容器</span>
FIELDS:
  name  <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>     <span class="token comment"># 容器名称</span>
  image <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>     <span class="token comment"># 容器需要的镜像地址</span>
  imagePullPolicy  <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> <span class="token comment"># 镜像拉取策略 </span>
  <span class="token builtin class-name">command</span>  <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>string<span class="token operator">&gt;</span> <span class="token comment"># 容器的启动命令列表，如不指定，使用打包时使用的启动命令</span>
  args   <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>string<span class="token operator">&gt;</span> <span class="token comment"># 容器的启动命令需要的参数列表 </span>
  <span class="token function">env</span>    <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token operator">&gt;</span> <span class="token comment"># 容器环境变量的配置</span>
  ports  <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Object<span class="token operator">&gt;</span>  <span class="token comment"># 容器需要暴露的端口号列表</span>
  resources <span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> <span class="token comment"># 资源限制和资源请求的设置</span>
</code></pre></div><h3 id="_3-1-基本配置"><a href="#_3-1-基本配置" class="header-anchor">#</a> 3.1 基本配置</h3> <ol><li>创建pod-base.yaml文件</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>base
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> xudaxian
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment"># 容器名称</span>
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1 <span class="token comment"># 容器需要的镜像地址</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox <span class="token comment"># 容器名称</span>
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span> <span class="token comment"># 容器需要的镜像地址</span>
</code></pre></div><ol start="2"><li>创建Pod：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> pod-base.yaml
</code></pre></div><ol start="3"><li>查看pod状态：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pod <span class="token parameter variable">-n</span> dev
</code></pre></div><ol start="4"><li>通过describe查看内部详情：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl describe pod -pod-base <span class="token parameter variable">-n</span> dev
</code></pre></div><h3 id="_3-2-镜像拉取策略"><a href="#_3-2-镜像拉取策略" class="header-anchor">#</a> 3.2 镜像拉取策略</h3> <ol><li>创建pod-imagepullpolicy.yaml文件：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>imagepullpolicy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> xudaxian
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment"># 容器名称</span>
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1 <span class="token comment"># 容器需要的镜像地址</span>
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always <span class="token comment"># 用于设置镜像的拉取策略</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox <span class="token comment"># 容器名称</span>
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span> <span class="token comment"># 容器需要的镜像地址</span>
</code></pre></div><p>imagePullPolicy设置镜像拉取策略：</p> <ul><li>Always：总是从远程仓库拉取镜像</li> <li>ifNotPresent：本地有则使用本地，没有就拉取远程</li> <li>Never：只使用本地镜像</li></ul> <h3 id="_3-3-启动命令"><a href="#_3-3-启动命令" class="header-anchor">#</a> 3.3 启动命令</h3> <ol><li>创建pod-command.yaml文件：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>apiVersion: v1
kind: Pod
metadata:
  name: pod-command
  namespace: dev
  labels:
    user: xudaxian
spec:
  containers:
    - name: nginx <span class="token comment"># 容器名称</span>
      image: nginx:1.17.1 <span class="token comment"># 容器需要的镜像地址</span>
      imagePullPolicy: IfNotPresent <span class="token comment"># 设置镜像拉取策略</span>
    - name: busybox <span class="token comment"># 容器名称</span>
      image: busybox:1.30 <span class="token comment"># 容器需要的镜像地址</span>
      command: <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span>,<span class="token string">&quot;-c&quot;</span>,<span class="token string">&quot;touch /tmp/hello.txt;while true;do /bin/echo <span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%T<span class="token variable">)</span></span> &gt;&gt; /tmp/hello.txt;sleep 3;done;&quot;</span><span class="token punctuation">]</span>
</code></pre></div><ol start="2"><li>进入Pod中的busybox容器，查看文件内容：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 在容器中执行命令</span>
<span class="token comment"># kubectl exec -it pod的名称 -n 命名空间 -c 容器名称 /bin/sh</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-command <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-c</span> busybox /bin/sh
</code></pre></div><h3 id="_3-4-环境变量"><a href="#_3-4-环境变量" class="header-anchor">#</a> 3.4 环境变量</h3> <p>不推荐环境变量方法，推荐将这些配置单独存储在配置文件中。</p> <ol><li>创建pod-evn.yaml文件：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>apiVersion: v1
kind: Pod
metadata:
  name: pod-env
  namespace: dev
  labels:
    user: xudaxian
spec:
  containers:
    - name: nginx <span class="token comment"># 容器名称</span>
      image: nginx:1.17.1 <span class="token comment"># 容器需要的镜像地址</span>
      imagePullPolicy: IfNotPresent <span class="token comment"># 设置镜像拉取策略</span>
    - name: busybox <span class="token comment"># 容器名称</span>
      image: busybox:1.30 <span class="token comment"># 容器需要的镜像地址</span>
      command: <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span>,<span class="token string">&quot;-c&quot;</span>,<span class="token string">&quot;touch /tmp/hello.txt;while true;do /bin/echo <span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%T<span class="token variable">)</span></span> &gt;&gt; /tmp/hello.txt;sleep 3;done;&quot;</span><span class="token punctuation">]</span>
      env:
        - name: <span class="token string">&quot;username&quot;</span>
          value: <span class="token string">&quot;admin&quot;</span>
        - name: <span class="token string">&quot;password&quot;</span>
          value: <span class="token string">&quot;123456&quot;</span>
</code></pre></div><ol start="2"><li>进入容器：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-env <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-c</span> busybox <span class="token parameter variable">-it</span> /bin/sh
<span class="token builtin class-name">echo</span> <span class="token variable">$username</span>
</code></pre></div><h3 id="_3-5-端口设置"><a href="#_3-5-端口设置" class="header-anchor">#</a> 3.5 端口设置</h3> <ol><li>查看端口支持的子选择</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl explain pod.spec.containers.ports
</code></pre></div><ol start="2"><li>创建pod-ports.yaml文件：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>ports
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> xudaxian
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment"># 容器名称</span>
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1 <span class="token comment"># 容器需要的镜像地址</span>
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent <span class="token comment"># 设置镜像拉取策略</span>
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port <span class="token comment"># 端口名称，如果执行，必须保证name在Pod中是唯一的</span>
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># 容器要监听的端口 （0~65536）</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP <span class="token comment"># 端口协议</span>
</code></pre></div><h3 id="_3-6-资源配额"><a href="#_3-6-资源配额" class="header-anchor">#</a> 3.6 资源配额</h3> <p>容器中的程序要运行，会占用一定的资源，比如CPU和内存等，Kubernetes提供了对内存和CPU的资源进行配额的机制，这种机制主要通过resources选项实现，它有两个子选择：</p> <ul><li>limits：用于限制运行容器的最大占用，超过重启。</li> <li>requests：用于设置需要的最小资源：如果资源不够，容器将无法启动。</li></ul> <ol><li>创建pod-resoures.yaml文件：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>resoures
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> xudaxian
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment"># 容器名称</span>
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1 <span class="token comment"># 容器需要的镜像地址</span>
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent <span class="token comment"># 设置镜像拉取策略</span>
      <span class="token key atrule">ports</span><span class="token punctuation">:</span> <span class="token comment"># 端口设置</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port <span class="token comment"># 端口名称，如果执行，必须保证name在Pod中是唯一的</span>
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># 容器要监听的端口 （0~65536）</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP <span class="token comment"># 端口协议</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token comment"># 资源配额</span>
        <span class="token key atrule">limits</span><span class="token punctuation">:</span> <span class="token comment"># 限制资源的上限</span>
          <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;2&quot;</span> <span class="token comment"># CPU限制，单位是core数</span>
          <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;10Gi&quot;</span> <span class="token comment"># 内存限制，可以使用Gi、Mi、G、M等形式。</span>
        <span class="token key atrule">requests</span><span class="token punctuation">:</span> <span class="token comment"># 限制资源的下限</span>
          <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span> <span class="token comment"># CPU限制，单位是core数 </span>
          <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;10Mi&quot;</span> <span class="token comment"># 内存限制，可以使用Gi、Mi、G、M等形式。</span>
</code></pre></div><p>如果将requests.memory的值改为10Gi，启动Pod会失败。使用describe查看详情会发现提示内存不足。</p> <h2 id="_4-pod的生命周期"><a href="#_4-pod的生命周期" class="header-anchor">#</a> 4 Pod的生命周期</h2> <h3 id="_4-1-概述"><a href="#_4-1-概述" class="header-anchor">#</a> 4.1 概述</h3> <p>Pod对象从创建到终止的这段时间范围称为Pod的生命周期，主要包含以下过程：</p> <ul><li>Pod创建过程</li> <li>运行初始化容器（init container）过程。</li> <li>运行主容器（main container）：
<ul><li>容器启动后钩子（post start），容器终止前钩子（pre stop）。</li> <li>容器的存活性探测（liveness probe），就绪性探测（readiness probe）</li></ul></li> <li>Pod终止过程。</li></ul> <p>在整个生命周期中，Pod会出现5种状态（相位）：</p> <ul><li>挂起（Pending）：API Server已经创建了Pod资源对象，但它尚未被调度完成或者任处于下载镜像的过程中</li> <li>运行中（Running）：Pod已经被调度到某节点，并且所有容器都已经被kubectl创建完成。</li> <li>成功（Succeeded）：Pod中所有容器都已经成功终止并且不会被重启。</li> <li>失败（Failed）：所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非0值的退出状态。</li> <li>未知（Unknown）：API Server无法正常获取到Pod对象的状态信息，通常由于网络通信失败所导致。</li></ul> <h3 id="_4-2-创建和终止"><a href="#_4-2-创建和终止" class="header-anchor">#</a> 4.2 创建和终止</h3> <h4 id="_4-2-1-pod的创建过程"><a href="#_4-2-1-pod的创建过程" class="header-anchor">#</a> 4.2.1 Pod的创建过程</h4> <ol><li>用户通过kubectl或其他api客户端提交需要创建的Pod信息给API Server。</li> <li>API Server开始生成Pod对象的信息，并将信息存入etcd，然后返回确认信息给客户端。</li> <li>API Server开始反映etcd中的Pod对象的变化，其它组件使用watch机制来跟踪检查API Server上的变动。</li> <li>Scheduler发现有新的Pod对象要创建，开始为Pod分配主机并将结果信息更新至API Server。</li> <li>Node节点上的kubelet发现有Pod调度过来，尝试调度Docker启动容器，并将结果回送至API Server。</li> <li>⑥ API Server将接收到的Pod状态信息存入到etcd中。</li></ol> <h4 id="_4-2-2-pod终止过程"><a href="#_4-2-2-pod终止过程" class="header-anchor">#</a> 4.2.2 Pod终止过程</h4> <ol><li>用户向API Server发送删除Pod对象的命令。</li> <li>API Server中的Pod对象信息会随着时间的推移而更新，在宽限期内（默认30s），Pod被视为dead。</li> <li>将Pod标记为terminating状态。</li> <li>kubelete在监控到Pod对象转为terminating状态的同时启动Pod关闭过程。</li> <li>端点控制器监控到Pod对象的关闭行为时将其从所有匹配到此端点的service资源的端点列表中移除。</li> <li>如果当前Pod对象定义了preStop钩子处理器，则在其标记为terminating后会以同步的方式启动执行。</li> <li>Pod对象中的容器进程收到停止信号。</li> <li>宽限期结束后，如果Pod中还存在运行的进程，那么Pod对象会收到立即终止的信号。</li> <li>kubectl请求API Server将此Pod资源的宽限期设置为0从而完成删除操作，此时Pod对于用户已经不可用了。</li></ol> <h3 id="_4-3-初始化容器"><a href="#_4-3-初始化容器" class="header-anchor">#</a> 4.3 初始化容器</h3> <h4 id="_4-3-1-概述"><a href="#_4-3-1-概述" class="header-anchor">#</a> 4.3.1 概述</h4> <p>初始化容器是在Pod的主容器启动之前要运行的容器，主要是做一些主容器的前置工作，它具有两大特征：</p> <ul><li>初始化容器必须运行完成直至结束，如果某个初始化容器运行失败，那么kubernetes需要重启它直至成功完成。</li> <li>初始化容器必须按照定义的顺序执行，当且仅当前一个成功之后，后面的一个才能运行。</li></ul> <p>初始化容器有很多的应用场景，下面列出的是最常见的几个：</p> <ul><li>提供主容器镜像中不具备的工具程序或自定义代码。</li> <li>初始化容器要先于应用容器串行启动并运行完成，因此可用于延后应用容器的启动直至其依赖的条件得到满足。</li></ul> <p>接下来做一个案例，模拟下面这个需求：</p> <ul><li>假设要以主容器来运行Nginx，但是要求在运行Nginx之前要能够连接上MySQL和Redis所在的服务器。</li> <li>为了简化测试，事先规定好MySQL和Redis所在的IP地址分别为192.168.18.103和192.168.18.104（注意，这两个IP都不能ping通，因为环境中没有这两个IP）。</li></ul> <h4 id="_4-3-2-示例"><a href="#_4-3-2-示例" class="header-anchor">#</a> 4.3.2 示例</h4> <ol><li>创建pod-initcontainer.yaml文件：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>initcontainer
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> xudaxian
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment"># 容器配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">resources</span><span class="token punctuation">:</span>
        <span class="token key atrule">limits</span><span class="token punctuation">:</span>
          <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;2&quot;</span>
          <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;10Gi&quot;</span>
        <span class="token key atrule">requests</span><span class="token punctuation">:</span>
          <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">&quot;1&quot;</span>
          <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">&quot;10Mi&quot;</span>
  <span class="token key atrule">initContainers</span><span class="token punctuation">:</span> <span class="token comment"># 初始化容器配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>mysql
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;until ping 192.168.18.103 -c 1;do echo waiting for mysql ...;sleep 2;done;&quot;</span><span class="token punctuation">]</span>
      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
        <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 使用特权模式运行容器</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>redis
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.30</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;until ping 192.168.18.104 -c 1;do echo waiting for redis ...;sleep 2;done;&quot;</span><span class="token punctuation">]</span>
</code></pre></div><ol start="2"><li>查看Pod状态</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl describe pod pod-initcontainer <span class="token parameter variable">-n</span> dev
</code></pre></div><p>可以返现Pod卡在启动的第一个初始化容器过程中，后面的容器不会运行。</p> <h3 id="_4-4-钩子函数"><a href="#_4-4-钩子函数" class="header-anchor">#</a> 4.4 钩子函数</h3> <h4 id="_4-4-1-概述"><a href="#_4-4-1-概述" class="header-anchor">#</a> 4.4.1 概述</h4> <p>钩子函数能够感知自身生命周期中的事件，并在相应的时刻到来时运行用户指定的程序代码。
kubernetes在主容器启动之后和停止之前提供了两个钩子函数：</p> <ul><li>post start：容器创建之后执行，如果失败会重启容器。</li> <li>pre stop：容器终止之前执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作。</li></ul> <p>钩子处理器支持使用下面的三种方式定义动作：</p> <ol><li>exec命令：在容器内执行一次命令。</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>……
  <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
     <span class="token key atrule">postStart</span><span class="token punctuation">:</span> 
        <span class="token key atrule">exec</span><span class="token punctuation">:</span>
           <span class="token key atrule">command</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> cat
             <span class="token punctuation">-</span> /tmp/healthy
……
</code></pre></div><ol start="2"><li>tcpSocket：在当前容器尝试访问指定的socket。</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>…… 
   <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
      <span class="token key atrule">postStart</span><span class="token punctuation">:</span>
         <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
……
</code></pre></div><ol start="3"><li>httpGet：在当前容器中向某url发起HTTP请求。</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>…… 
   <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
      <span class="token key atrule">postStart</span><span class="token punctuation">:</span>
         <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> / <span class="token comment">#URI地址</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment">#端口号</span>
            <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.109.100 <span class="token comment">#主机地址  </span>
            <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP <span class="token comment">#支持的协议，http或者https</span>
……
</code></pre></div><h4 id="_4-4-2-exec方式"><a href="#_4-4-2-exec方式" class="header-anchor">#</a> 4.4.2 exec方式</h4> <p>以exec方式为例，演示下钩子函数的使用。</p> <ol><li>创建pod-hook-exec.yaml文件</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>apiVersion: v1
kind: Pod
metadata:
  name: pod-hook-exec
  namespace: dev
  labels:
    user: xudaxian
spec:
  containers: <span class="token comment"># 容器配置</span>
    - name: nginx
      image: nginx:1.17.1
      imagePullPolicy: IfNotPresent
      ports:
        - name: nginx-port
          containerPort: <span class="token number">80</span>
          protocol: TCP
      resources:
        limits:
          cpu: <span class="token string">&quot;2&quot;</span>
          memory: <span class="token string">&quot;10Gi&quot;</span>
        requests:
          cpu: <span class="token string">&quot;1&quot;</span>
          memory: <span class="token string">&quot;10Mi&quot;</span>
      lifecycle: <span class="token comment"># 生命周期配置</span>
        postStart: <span class="token comment"># 容器创建之后执行，如果失败会重启容器</span>
          exec: <span class="token comment"># 在容器启动的时候，执行一条命令，修改掉Nginx的首页内容</span>
            command: <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span>,<span class="token string">&quot;-c&quot;</span>,<span class="token string">&quot;echo postStart ... &gt; /usr/share/nginx/html/index.html&quot;</span><span class="token punctuation">]</span>
        preStop: <span class="token comment"># 容器终止之前执行，执行完成之后容器将成功终止，在其完成之前会阻塞删除容器的操作</span>
          exec: <span class="token comment"># 在容器停止之前停止Nginx的服务</span>
            command: <span class="token punctuation">[</span><span class="token string">&quot;/usr/sbin/nginx&quot;</span>,<span class="token string">&quot;-s&quot;</span>,<span class="token string">&quot;quit&quot;</span><span class="token punctuation">]</span>
</code></pre></div><ol start="2"><li>查看Pod的IP</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pod pod-hook-exec <span class="token parameter variable">-n</span> dev <span class="token parameter variable">-o</span> wide
</code></pre></div><ol start="3"><li>访问Pod</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> <span class="token number">10.244</span>.1.11
</code></pre></div><h3 id="_4-5-容器探测"><a href="#_4-5-容器探测" class="header-anchor">#</a> 4.5 容器探测</h3> <h4 id="_4-5-1-概述"><a href="#_4-5-1-概述" class="header-anchor">#</a> 4.5.1 概述</h4> <p>容器探测用于检测容器中的应用实例是否正常工作，是保障业务可用性的一种传统机制。如果经过探测，实例的状态不符合预期，那么kubernetes就会把该问题实例“摘除”，不承担业务流量。kubernetes提供了两种探针来实现容器探测，分别是：</p> <ul><li>liveness probes：存活性探测，用于检测应用实例当前是否处于正常运行状态，如果不是，k8s会重启容器。</li> <li>readiness probes：就绪性探测，用于检测应用实例是否可以接受请求，如果不能，k8s不会转发流量。</li></ul> <blockquote><p>livenessProbe：存活性探测，决定是否重启容器。
readinessProbe：就绪性探测，决定是否将请求转发给容器。</p></blockquote> <blockquote><p>k8s在1.16版本之后新增了startupProbe探针，用于判断容器内应用程序是否已经启动。如果配置了startupProbe探针，就会先禁止其他的探针，直到startupProbe探针成功为止，一旦成功将不再进行探测。</p></blockquote> <p>上面两种探针目前均支持三种探测方式：</p> <ol><li>exec命令：在容器内执行一次命令，如果命令执行的退出码为0，则认为程序正常，否则不正常。</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>……
  <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
     <span class="token key atrule">exec</span><span class="token punctuation">:</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span>	cat
          <span class="token punctuation">-</span>	/tmp/healthy
……
</code></pre></div><ol start="2"><li>tcpSocket：将会尝试访问一个用户容器的端口，如果能够建立这条连接，则认为程序正常，否则不正常。</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>……
   <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
         <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
……
</code></pre></div><ol start="3"><li>httpGet：调用容器内web应用的URL，如果返回的状态码在200和399之前，则认为程序正常，否则不正常。</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code>……
   <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
         <span class="token key atrule">path</span><span class="token punctuation">:</span> / <span class="token comment">#URI地址</span>
         <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment">#端口号</span>
         <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1 <span class="token comment">#主机地址</span>
         <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP <span class="token comment">#支持的协议，http或者https</span>
……
</code></pre></div><h4 id="_4-5-2-exec方式"><a href="#_4-5-2-exec方式" class="header-anchor">#</a> 4.5.2 exec方式</h4> <ol><li>创建pod-liveness-exec.yaml文件：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>liveness<span class="token punctuation">-</span>exec
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> xudaxian
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment"># 容器配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span> <span class="token comment"># 存活性探针</span>
        <span class="token key atrule">exec</span><span class="token punctuation">:</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/cat&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;/tmp/hello.txt&quot;</span><span class="token punctuation">]</span> <span class="token comment"># 执行一个查看文件的命令，必须失败，因为根本没有这个文件</span>
</code></pre></div><ol start="2"><li>查看Pod详情：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl describe pod pod-liveness-exec <span class="token parameter variable">-n</span> dev
</code></pre></div><p>会报错Liveness Probe failed：没有这个文件或目录。</p> <blockquote><ul><li>nginx容器启动之后就进行了健康检查。</li> <li>检查失败之后，容器被kill掉，然后尝试进行重启，这是重启策略的作用。</li> <li>稍等一会之后，再观察Pod的信息，就会看到RESTARTS不再是0，而是一直增长。</li></ul></blockquote> <h4 id="_4-5-3-容器探测补充"><a href="#_4-5-3-容器探测补充" class="header-anchor">#</a> 4.5.3 容器探测补充</h4> <p>查看livenessProbe的子属性，会发现除了这三种方式，还有一些其他的配置。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl explain pod.spec.containers.livenessProbe
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>FIELDS:
  <span class="token builtin class-name">exec</span> 
  tcpSocket  
  httpGet    
  initialDelaySeconds    <span class="token comment"># 容器启动后等待多少秒执行第一次探测</span>
  timeoutSeconds      <span class="token comment"># 探测超时时间。默认1秒，最小1秒</span>
  periodSeconds       <span class="token comment"># 执行探测的频率。默认是10秒，最小1秒</span>
  failureThreshold    <span class="token comment"># 连续探测失败多少次才被认定为失败。默认是3。最小值是1</span>
  successThreshold    <span class="token comment"># 连续探测成功多少次才被认定为成功。默认是1</span>
</code></pre></div><h3 id="_4-6-重启策略"><a href="#_4-6-重启策略" class="header-anchor">#</a> 4.6 重启策略</h3> <h4 id="_4-6-1-概述"><a href="#_4-6-1-概述" class="header-anchor">#</a> 4.6.1 概述</h4> <p>在容器探测中，一旦容器探测出现了问题，kubernetes就会对容器所在的Pod进行重启，其实这是由Pod的重启策略决定的，Pod的重启策略有3种，分别如下：</p> <ul><li>Always：容器失效时，自动重启该容器，默认值。</li> <li>OnFailure：容器终止运行且退出码不为0时重启。</li> <li>Never：不论状态如何，都不重启该容器。</li></ul> <p>重启策略适用于Pod对象中的所有容器，首次需要重启的容器，将在其需要的时候立即进行重启，随后再次重启的操作将由kubelet延迟一段时间后进行，且反复的重启操作的延迟时长以此为10s、20s、40s、80s、160s和300s，300s是最大的延迟时长。</p> <h4 id="_4-6-2-示例"><a href="#_4-6-2-示例" class="header-anchor">#</a> 4.6.2 示例</h4> <ol><li>创建pod-restart-policy.yaml文件：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>restart<span class="token punctuation">-</span>policy
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> xudaxian
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment"># 容器配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span> <span class="token comment"># 存活性探测</span>
        <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
          <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /hello
          <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1
          <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never <span class="token comment"># 重启策略</span>
</code></pre></div><p>我们设置了存活性探测访问本地80端口的<code>/hello</code>地址，但是实际上没有这个地址，会访问失败，所以容器会启动失败。多等一会，观察Pod的重试次数，发现一直是0，没有重启。</p> <h2 id="_5-pod的调度"><a href="#_5-pod的调度" class="header-anchor">#</a> 5 Pod的调度</h2> <p>在默认情况下，一个Pod在哪个Node节点上运行，是由Scheduler组件采用相应的算法计算出来的，这个过程是不受人工控制的。但是在实际使用中，这并不满足需求，因为很多情况下，我们想控制某些Pod到达某些节点上，那么应该怎么做？这就要求了解kubernetes对Pod的调度规则，kubernetes提供了四大类调度方式。</p> <ul><li>自动调度：运行在哪个Node节点上完全由Scheduler经过一系列的算法计算得出。</li> <li>定向调度：NodeName、NodeSelector。</li> <li>亲和性调度：NodeAffinity、PodAffinity、PodAntiAffinity。</li> <li>污点（容忍）调度：Taints、Toleration。</li></ul> <h3 id="_5-1-定向调度"><a href="#_5-1-定向调度" class="header-anchor">#</a> 5.1 定向调度</h3> <h4 id="_5-1-1-概述"><a href="#_5-1-1-概述" class="header-anchor">#</a> 5.1.1 概述</h4> <p>定向调度，指的是利用在Pod上声明的nodeName或nodeSelector，以此将Pod调度到期望的Node节点上。注意，这里的调度是强制的，这就意味着即使要调度的目标Node不存在，也会向上面进行调度，只不过Pod运行失败而已。</p> <h4 id="_5-1-2-示例"><a href="#_5-1-2-示例" class="header-anchor">#</a> 5.1.2 示例</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodename
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> xudaxian
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment"># 容器配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>node1 <span class="token comment"># 指定调度到k8s-node1节点上</span>
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">nodeenv</span><span class="token punctuation">:</span> pro <span class="token comment"># 指定调度到具有nodeenv=pro的Node节点上</span>
</code></pre></div><h3 id="_5-2-亲和性调度"><a href="#_5-2-亲和性调度" class="header-anchor">#</a> 5.2 亲和性调度</h3> <h4 id="_5-2-1-概述"><a href="#_5-2-1-概述" class="header-anchor">#</a> 5.2.1 概述</h4> <p>虽然定向调度的两种方式，使用起来非常方便，但是也有一定的问题，那就是如果没有满足条件的Node，那么Pod将不会被运行，即使在集群中还有可用的Node列表也不行，这就限制了它的使用场景。
基于上面的问题，kubernetes还提供了一种亲和性调度（Affinity）。它在nodeSelector的基础之上进行了扩展，可以通过配置的形式，实现优先选择满足条件的Node进行调度，如果没有，也可以调度到不满足条件的节点上，使得调度更加灵活。
Affinity主要分为三类：</p> <ul><li>nodeAffinity（node亲和性）：以Node为目标，解决Pod可以调度到那些Node的问题。</li> <li>podAffinity（pod亲和性）：以Pod为目标，解决Pod可以和那些已存在的Pod部署在同一个拓扑域中的问题。</li> <li>podAntiAffinity（pod反亲和性）：以Pod为目标，解决Pod不能和那些已经存在的Pod部署在同一拓扑域中的问题。</li></ul> <blockquote><p>关于亲和性和反亲和性的使用场景的说明：</p> <ul><li>亲和性：如果两个应用频繁交互，那么就有必要利用亲和性让两个应用尽可能的靠近，这样可以较少因网络通信而带来的性能损耗。</li> <li>反亲和性：当应用采用多副本部署的时候，那么就有必要利用反亲和性让各个应用实例打散分布在各个Node上，这样可以提高服务的高可用性。</li></ul></blockquote> <h4 id="_5-2-2-nodeaffinity"><a href="#_5-2-2-nodeaffinity" class="header-anchor">#</a> 5.2.2 nodeAffinity</h4> <p>查看nodeAffinity的可选配置项</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># pod.spec.affinity.nodeAffinity</span>
  requiredDuringSchedulingIgnoredDuringExecution  <span class="token comment"># Node节点必须满足指定的所有规则才可以，相当于硬限制</span>
    nodeSelectorTerms  <span class="token comment"># 节点选择列表 </span>
      matchExpressions  <span class="token comment"># 按节点标签列出的节点选择器要求列表(推荐)</span>
        key  <span class="token comment">#  键</span>
        values <span class="token comment"># 值</span>
        operator <span class="token comment"># 关系符 支持Exists, DoesNotExist, In, NotIn, Gt, Lt</span>
  preferredDuringSchedulingIgnoredDuringExecution <span class="token comment"># 优先调度到满足指定的规则的Node，相当于软限制 (倾向)     </span>
    preference <span class="token comment"># 一个节点选择器项，与相应的权重相关联</span>
      matchExpressions <span class="token comment"># 按节点标签列出的节点选择器要求列表(推荐)</span>
        key <span class="token comment"># 键</span>
        values <span class="token comment"># 值</span>
        operator <span class="token comment"># 关系符 支持In, NotIn, Exists, DoesNotExist, Gt, Lt  </span>
    weight <span class="token comment"># 倾向权重，在范围1-100。</span>
</code></pre></div><p><strong>演示requiredDuringSchedulingIgnoredDuringExecution</strong></p> <ol><li>创建pod-nodeaffinity-required.yaml文件</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>required
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment"># 容器配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token comment"># 亲和性配置</span>
    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span> <span class="token comment"># node亲和性配置</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment"># Node节点必须满足指定的所有规则才可以，相当于硬规则，类似于定向调度</span>
        <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span> <span class="token comment"># 节点选择列表</span>
          <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nodeenv <span class="token comment"># 匹配存在标签的key为nodeenv的节点，并且value是&quot;xxx&quot;或&quot;yyy&quot;的节点</span>
                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> <span class="token string">&quot;xxx&quot;</span>
                  <span class="token punctuation">-</span> <span class="token string">&quot;yyy&quot;</span>
</code></pre></div><p><strong>演示preferredDuringSchedulingIgnoredDuringExecution</strong></p> <ol><li>创建pod-nodeaffinity-preferred.yaml文件</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>nodeaffinity<span class="token punctuation">-</span>preferred
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment"># 容器配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token comment"># 亲和性配置</span>
    <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span> <span class="token comment"># node亲和性配置</span>
      <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment"># 优先调度到满足指定的规则的Node，相当于软限制 (倾向)</span>
        <span class="token punctuation">-</span> <span class="token key atrule">preference</span><span class="token punctuation">:</span> <span class="token comment"># 一个节点选择器项，与相应的权重相关联</span>
            <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nodeenv
                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> <span class="token string">&quot;xxx&quot;</span>
                  <span class="token punctuation">-</span> <span class="token string">&quot;yyy&quot;</span>
          <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre></div><blockquote><p>nodeAffinity的注意事项：</p> <ul><li>如果同时定义了nodeSelector和nodeAffinity，那么必须两个条件都满足，Pod才能运行在指定的Node上。</li> <li>如果nodeAffinity指定了多个nodeSelectorTerms，那么只需要其中一个能够匹配成功即可。</li> <li>如果一个nodeSelectorTerms中有多个matchExpressions，则一个节点必须满足所有的才能匹配成功。</li> <li>如果一个Pod所在的Node在Pod运行期间其标签发生了改变，不再符合该Pod的nodeAffinity的要求，则系统将忽略此变化。</li></ul></blockquote> <h4 id="_5-2-3-podaffinity"><a href="#_5-2-3-podaffinity" class="header-anchor">#</a> 5.2.3 podAffinity</h4> <p>podAffinity主要实现以运行的Pod为参照，实现让新创建的Pod和参照的Pod在一个区域的功能。</p> <div class="language- extra-class"><pre class="language-text"><code>pod.spec.affinity.podAffinity
  requiredDuringSchedulingIgnoredDuringExecution  硬限制
    namespaces 指定参照pod的namespace
    topologyKey 指定调度作用域
    labelSelector 标签选择器
      matchExpressions  按节点标签列出的节点选择器要求列表(推荐)
        key    键
        values 值
        operator 关系符 支持In, NotIn, Exists, DoesNotExist.
      matchLabels    指多个matchExpressions映射的内容  
  preferredDuringSchedulingIgnoredDuringExecution 软限制    
    podAffinityTerm  选项
      namespaces
      topologyKey
      labelSelector
         matchExpressions 
            key    键  
            values 值  
            operator
         matchLabels 
    weight 倾向权重，在范围1-1
</code></pre></div><blockquote><p>topologyKey用于指定调度的作用域，例如:</p> <ul><li>如果指定为kubernetes.io/hostname，那就是以Node节点为区分范围。</li> <li>如果指定为beta.kubernetes.io/os，则以Node节点的操作系统类型来区分。</li></ul></blockquote> <p><strong>演示requiredDuringSchedulingIgnoredDuringExecution</strong></p> <ol><li>创建参照pod：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>podaffinity<span class="token punctuation">-</span>target
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">podenv</span><span class="token punctuation">:</span> pro <span class="token comment"># 设置标签</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment"># 容器配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>node1 <span class="token comment"># 将目标pod定向调度到k8s-node1</span>
</code></pre></div><ol start="2"><li>创建podAffinity的pod：</li></ol> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>podaffinity<span class="token punctuation">-</span>requred
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment"># 容器配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token comment"># 亲和性配置</span>
    <span class="token key atrule">podAffinity</span><span class="token punctuation">:</span> <span class="token comment"># Pod亲和性</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment"># 硬限制</span>
        <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
            <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span> <span class="token comment"># 该Pod必须和拥有标签podenv=xxx或者podenv=yyy的Pod在同一个Node上，显然没有这样的Pod</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> podenv
                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> <span class="token string">&quot;pro&quot;</span>
                  <span class="token punctuation">-</span> <span class="token string">&quot;yyy&quot;</span>
          <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname
</code></pre></div><h4 id="_5-2-4-podantiaffinity"><a href="#_5-2-4-podantiaffinity" class="header-anchor">#</a> 5.2.4 podAntiAffinity</h4> <p>podAntiAffinity主要实现以运行的Pod为参照，让新创建的Pod和参照的Pod不在一个区域的功能。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>podantiaffinity<span class="token punctuation">-</span>requred
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment"># 容器配置</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.1
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token comment"># 亲和性配置</span>
    <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span> <span class="token comment"># Pod反亲和性</span>
      <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span> <span class="token comment"># 硬限制</span>
        <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
            <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> podenv
                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> <span class="token string">&quot;pro&quot;</span>
          <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/other/Kubernetes/3-Kubernetes的对象.html" class="prev">
        3.Kubernetes的对象
      </a></span> <span class="next"><a href="/guide/other/Kubernetes/5-Kubernetes的控制器.html">
        5.Kubernetes的控制器
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7bd49d80.js" defer></script><script src="/assets/js/2.63c13255.js" defer></script><script src="/assets/js/63.d5389af7.js" defer></script>
  </body>
</html>
